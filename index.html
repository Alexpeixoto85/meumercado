


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEU CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --light: #ecf0f1;
            --dark: #34495e;
            --white: #fff;
            --gray: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--secondary);
            color: white;
            padding: 20px 0;
            position: relative;
        }

        .logo {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo h2 {
            color: var(--primary);
        }

        .logo img {
            max-width: 100%;
            max-height: 80px;
            margin-bottom: 10px;
        }

        .menu {
            margin-top: 20px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--primary);
        }

        .logout-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background-color: var(--danger);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .logout-btn i {
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: var(--light);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            color: var(--secondary);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1a252f;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-info { /* New style for view buttons */
            background-color: var(--info);
            color: white;
        }

         .btn-info:hover { /* New style for view buttons */
            background-color: #16a085;
        }


        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background-color: #f8f9fa;
            color: var(--secondary);
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-primary {
            background-color: var(--primary);
            color: white;
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger);
            color: white;
        }

        .badge-info {
            background-color: var(--info);
            color: white;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto; /* Allow scrolling for modal */
        }

         .modal-content, .view-modal-content { /* Apply styles to both edit and view modals */
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .view-modal-content { /* Specific styles for view modals */
             max-width: 700px;
             /* Slightly wider for detail view */
        }


        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            color: var(--secondary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        select.form-control {
            height: 40px;
        }

         /* Detail View Card Layout */
        .property-detail-card, .lead-detail-card, .appointment-detail-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .property-detail-card h3, .lead-detail-card h3, .appointment-detail-card h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

         .property-detail-name, .lead-detail-name, .appointment-detail-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
         }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section h4 {
            color: var(--secondary);
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
            padding-left: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .detail-item strong {
            color: var(--dark);
        }


        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
             cursor: pointer;
             /* Make stat cards clickable */
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        /* Image Gallery & Document Preview */
        .image-gallery, .document-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview, .document-item {
            position: relative;
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            /* Use flex for centering document icons */
            justify-content: center;
            align-items: center;
             background-color: #e9ecef; /* Light background for documents */
             cursor: pointer; /* Make image previews clickable */
        }

         .document-item i {
            font-size: 30px;
            color: var(--secondary);
         }


        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-image, .document-item .remove-document {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* Backup Section */
        .backup-section {
            margin-top: 30px;
        }

        .backup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Communication buttons */
        .communication-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .communication-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
        }

        .sms-btn {
            background-color: #34B7F1;
            color: white;
            border: none;
        }

        .email-btn {
            background-color: #EA4335;
            color: white;
            border: none;
        }

        /* PDF Reports */
        .pdf-container {
            padding: 20px;
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .pdf-button {
            margin: 10px 0;
            padding: 10px 15px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pdf-button:hover {
            background-color: #c0392b;
        }

        /* Funnel */
        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .funnel-step {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .funnel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .funnel-title {
            font-weight: bold;
            color: var(--secondary);
        }

        .funnel-count {
            background-color: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
        }

        .funnel-leads {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .funnel-lead {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .funnel-lead:last-child {
            border-bottom: none;
        }

        .funnel-lead-name {
            font-weight: 500;
        }

        .funnel-lead-actions {
            display: flex;
            gap: 5px;
        }

        /* Receipt */
        .receipt-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .receipt-title {
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .receipt-details {
            margin-bottom: 20px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .receipt-label {
            font-weight: bold;
        }

        .receipt-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .menu {
                height: auto;
                max-height: 300px;
            }

            .logout-btn {
                position: static;
                margin-top: 20px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .backup-actions {
                flex-direction: column;
            }

            .communication-buttons {
                flex-direction: column;
            }
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Backup Status */
        .backup-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        .backup-status.success {
            color: var(--success);
            background-color: rgba(46, 204, 113, 0.1);
        }

        .backup-status.error {
            color: var(--danger);
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* Filtros */
        .filters {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        /* Cartão de anúncio */
        .property-ad-card {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            display: flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .property-ad-image {
            width: 50%;
            height: 300px;
            object-fit: cover;
        }

        .property-ad-content {
            width: 50%;
            padding: 20px;
            background: white;
        }

        /* Gráfico em torre */
        .tower-chart-container {
            height: 400px;
            margin-top: 30px;
        }

        /* Calendário */
        #calendar {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Print styles for modals */
        @media print {
            body > *:not(.modal-to-print) {
                display: none !important;
            }
            .modal-to-print {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                overflow: visible;
            }
            .modal-to-print .modal-header,
            .modal-to-print .modal-footer,
            .modal-to-print .close {
                 display: none !important;
            }
             .modal-to-print .modal-content,
             .modal-to-print .view-modal-content {
                width: 100% !important;
                max-width: 100% !important;
                box-shadow: none;
                border-radius: 0;
                 max-height: none !important;
                 overflow: visible;
            }

             .modal-to-print .modal-body {
                 padding: 0;
                 /* Remove padding for full use of space */
             }

             /* Ensure images/documents are visible and scale */
             .modal-to-print .image-gallery,
             .modal-to-print .document-preview {
                 display: block;
                 /* Stack images/documents */
                 margin-top: 10px;
             }

             .modal-to-print .image-preview,
             .modal-to-print .document-item {
                 width: 100%;
                 /* Full width */
                 height: auto;
                 /* Auto height */
                 margin-bottom: 5px;
                 /* Space between items */
                 border: none;
                 /* Remove border */
                 border-radius: 0;
             }

             .modal-to-print .image-preview img {
                 max-width: 100%;
                 /* Ensure images fit within width */
                 height: auto;
                 object-fit: contain; /* Contain image within bounds */
             }
             .modal-to-print .document-item a {
                 display: flex;
                 align-items: center;
             }
             .modal-to-print .document-item i {
                 margin-right: 5px;
                 /* Space between icon and name */
             }

        }
        /* Styles for the Appointment Alert */
        #appointment-alert .modal-content {
            max-width: 500px;
            /* Make the alert box slightly smaller */
        }

        .appointment-alert-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .appointment-alert-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .appointment-alert-details {
            flex-grow: 1;
            margin-right: 10px;
        }

        .appointment-alert-details strong {
            color: var(--secondary);
        }

        .appointment-alert-actions .btn {
            padding: 5px 10px;
            /* Smaller buttons in the alert */
            font-size: 12px;
        }

        .close-alert {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
         /* Adicione isso na seção de estilos existente */
        .stat-card.blink {
            animation: blink-animation 1s steps(2, start) infinite;
        }
        @keyframes blink-animation {
            to {
                background-color: #fff3cd;
            }
        }
         /* Adicione ao seu CSS existente */
        #import-history-table {
            font-size: 14px;
        }

        #import-history-table th, #import-history-table td {
            padding: 8px 12px;
        }

         /* Image Viewer Modal Styles */
        #image-viewer-modal .modal-content {
            background-color: rgba(0, 0, 0, 0.8); /* Darker background */
            max-width: 95%;
            max-height: 95%;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #image-viewer-modal .modal-body {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px; /* Add some padding */
        }

        #image-viewer-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensure the entire image is visible */
        }

        #image-viewer-modal .modal-footer {
            border-top: none;
            padding: 10px 20px;
            justify-content: space-between;
            width: 100%;
            color: white;
        }

         #image-viewer-modal .modal-footer button {
             background: rgba(255, 255, 255, 0.2); /* Semi-transparent buttons */
             color: white;
             border: none;
             padding: 10px 15px;
             cursor: pointer;
             border-radius: 50%;
             width: 40px;
             height: 40px;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 20px;
         }

         #image-viewer-modal .modal-footer button:hover {
              background: rgba(255, 255, 255, 0.4);
         }

         #image-viewer-modal .modal-header {
            border-bottom: none;
            padding: 10px 20px;
            width: 100%;
            justify-content: flex-end;
         }

        #image-viewer-modal .close {
            color: white;
            font-size: 30px;
        }

    </style>
<style>.menu-item[data-page="marketing"], #marketing-page { display: none !important; }</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

<style>
#new-leads-list { background-color: #e3f2fd; }
#contacted-leads-list { background-color: #d0f0c0; }
#interested-leads-list { background-color: #fff9c4; }
#proposal-leads-list { background-color: #ffe0b2; }
#negotiation-leads-list { background-color: #e1bee7; }
#closed-leads-list { background-color: #c8e6c9; }
</style>

</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="logo">
                <img id="crm-logo" src="" alt="Logo CRM">
                <h2><i class="fas fa-home"></i> MEU CRM</h2>
            </div>
            <div class="menu">
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </div>
                <div class="menu-item" data-page="leads">
                    <i class="fas fa-users"></i> Clientes
                </div>
                <div class="menu-item" data-page="funnel">
                    <i class="fas fa-filter"></i> Funil de Vendas
                </div>
                <div class="menu-item" data-page="properties">
                    <i class="fas fa-building"></i> Imóveis
                </div>
                <div class="menu-item" data-page="appointments">
                    <i class="fas fa-calendar-alt"></i> Agendamentos
                </div>
                <div class="menu-item" data-page="tables">
                    <i class="fas fa-table"></i> Tabelas
                </div>
                <div class="menu-item" data-page="financial">
                    <i class="fas fa-dollar-sign"></i> Financeiro
                </div>
                <div class="menu-item" data-page="reports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </div>
                <div class="menu-item" data-page="links"><i class="fas fa-link"></i> Links</div>
                <div class="menu-item" data-page="notes">
                    <i class="fas fa-sticky-note"></i> Notas
                </div>
                <div class="menu-item" data-page="marketing">
                    <i class="fas fa-bullhorn"></i> Marketing
                </div>
                <div class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i> Configurações
                </div>
            </div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Sair do CRM
            </button>
        </div>

        <div class="main-content">
            <div id="dashboard-page" class="page" style="display: block;">
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                    <button id="new-lead-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Clientes Ativos</div>
                        <div class="stat-value" id="active-leads-count">0</div>
                        <div class="stat-label">Total de Clientes: <span id="total-leads-count">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Imóveis Disponíveis</div>
                        <div class="stat-value" id="available-properties-count">0</div>
                        <div class="stat-label">Total de Imóveis: <span id="total-properties-count">0</span></div>
                    </div>
                    <div class="stat-card" onclick="showAppointmentAlerts()">
                        <div class="stat-label">Agendamentos Hoje</div>
                        <div class="stat-value" id="today-appointments-count">0</div>
                        <div class="stat-label">Total Agendamentos: <span id="total-appointments-count">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Receita do Mês</div>
                        <div class="stat-value" id="monthly-revenue">R$ 0,00</div>
                        <div class="stat-label">Total Recebido: <span id="total-revenue">R$ 0,00</span></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Clientes Recentes</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Interesse</th>
                                <th>Status</th>
                                <th>Último Contato</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="recent-leads-table">
                            </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 10px;">
                        <a href="#" id="view-all-leads" style="color: var(--primary);">Ver todos os clientes</a>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Imóveis Recentes</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                 <th>Nome</th>
                                 <th>Tipo</th>
                                <th>Endereço</th>
                                <th>Preço</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="recent-properties-table">
                            </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 10px;">
                        <a href="#" id="view-all-properties" style="color: var(--primary);">Ver todos os imóveis</a>
                    </div>
                </div>
            </div>

            <div id="leads-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Clientes</h1>
                    <button id="new-lead-btn2" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>

                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Interesse</th>
                                <th>Origem</th>
                                <th>Status</th>
                                <th>Último Contato</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="all-leads-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="funnel-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Funil de Vendas</h1>
                </div>

                <div class="card">
                    <div class="funnel-container">
                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Novos Clientes</div>
                                <div class="funnel-count" id="new-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="new-leads-list">
                            </div>
                        </div>

                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Contatados</div>
                                <div class="funnel-count" id="contacted-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="contacted-leads-list">
                                </div>
                        </div>

                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Interessados</div>
                                <div class="funnel-count" id="interested-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="interested-leads-list">
                                </div>
                        </div>

                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Proposta Enviada</div>
                                <div class="funnel-count" id="proposal-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="proposal-leads-list">
                                </div>
                        </div>

                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Negociação</div>
                                <div class="funnel-count" id="negotiation-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="negotiation-leads-list">
                                </div>
                        </div>

                        <div class="funnel-step">
                            <div class="funnel-header">
                                <div class="funnel-title">Fechados</div>
                                <div class="funnel-count" id="closed-leads-count">0</div>
                            </div>
                            <div class="funnel-leads" id="closed-leads-list">
                                </div>
                            </div>
                    </div>
                </div>
            </div>

            <div id="properties-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Imóveis</h1>
                    <button id="new-property-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Imóvel
                    </button>
                </div>

                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                 <th>Nome</th>
                                 <th>Tipo</th>
                                <th>Endereço</th>
                                <th>Preço</th>
                                <th>Área (m²)</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="all-properties-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="appointments-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Agendamentos</h1>
                    <button id="new-appointment-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Agendamento
                    </button>
                </div>

                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Cliente</th>
                                <th>Imóvel</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tables-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Importar Tabelas</h1>
                </div>

                <div class="card">
                    <h3 class="card-title">Importar Arquivo para Estoque</h3>
                    <div class="form-group">
                        <label class="form-label">Selecione o arquivo (CSV ou Excel)</label>
                        <input type="file" id="import-file" class="form-control" accept=".csv,.xlsx,.xls">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selecione o Imóvel</label>
                        <select id="import-property" class="form-control">
                            <option value="">Selecione um imóvel</option>
                        </select>
                    </div>
                    <button id="import-table-btn" class="btn btn-primary">
                        <i class="fas fa-file-import"></i> Importar Tabela
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title">Últimas Importações</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Imóvel</th>
                                <th>Itens Importados</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="import-history-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="financial-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Financeiro</h1>
                    <div>
                        <button id="new-transaction-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nova Transação
                        </button>
                        <button id="new-receipt-btn" class="btn btn-success">
                            <i class="fas fa-file-invoice"></i> Emitir Recibo
                        </button>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Receita Total</div>
                        <div class="stat-value" id="total-income">R$ 0,00</div>
                        <div class="stat-label">Últimos 30 dias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Despesas Totais</div>
                        <div class="stat-value" id="total-expenses">R$ 0,00</div>
                        <div class="stat-label">Últimos 30 dias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Saldo Atual</div>
                        <div class="stat-value" id="current-balance">R$ 0,00</div>
                        <div class="stat-label">Disponível</div>
                    </div>
                </div>

                <div class="card">
                    <div class="header">
                        <h3 class="card-title">Últimas Transações</h3>
                        <div>
                            <select id="financial-filter" class="form-control" style="width: 200px; display: inline-block;">
                                <option value="all">Todas</option>
                                <option value="income">Receitas</option>
                                <option value="expense">Despesas</option>
                                <option value="venda">Vendas</option>
                                <option value="aluguel">Aluguéis</option>
                            </select>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="reports-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Relatórios</h1>
                </div>

                <div class="pdf-container">
                    <h3>Gerar Relatórios em PDF</h3>
                    <button class="pdf-button" data-report-type="leads">
                        <i class="fas fa-file-pdf"></i> Relatório de Clientes
                    </button>
                    <button class="pdf-button" data-report-type="properties">
                        <i class="fas fa-file-pdf"></i> Relatório de Imóveis
                    </button>
                    <button class="pdf-button" data-report-type="financial">
                        <i class="fas fa-file-pdf"></i> Relatório Financeiro
                    </button>
                    <button class="pdf-button" data-report-type="funnel">
                        <i class="fas fa-file-pdf"></i> Relatório de Funil
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title">Clientes por Origem</h3>
                    <div class="chart-container">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Vendas por Mês</h3>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Fluxo Financeiro</h3>
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="marketing-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Marketing</h1>
                </div>
                <div class="card">
                    <div id="marketing-container"></div>
                </div>
            </div>

            <div id="settings-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Configurações</h1>
                </div>

                <div class="card">
                    <h3 class="card-title">Personalização</h3>
                    <div class="form-group">
                        <label class="form-label">Logo da Empresa</label>
                        <input type="file" id="company-logo" class="form-control" accept="image/*">
                        <div class="image-preview" id="logo-preview"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome da Imobiliária</label>
                        <input type="text" id="company-name" class="form-control" value="MEU CRM">
                    </div>
                    <button id="save-branding" class="btn btn-primary">Salvar Personalização</button>
                </div>

                <div class="card">
                    <h3 class="card-title">Usuários do Sistema</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Perfil</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            </tbody>
                    </table>
                    <button id="new-user-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Usuário
                    </button>
                </div>

                <div class="card backup-section">
                    <h3 class="card-title">Backup de Dados</h3>
                    <p>Exporte ou importe um backup completo dos dados do sistema.</p>

                    <div class="backup-actions">
                        <button id="export-backup" class="btn btn-primary">
                            <i class="fas fa-file-export"></i> Exportar Backup
                        </button>
                        <button id="import-backup" class="btn btn-secondary">
                            <i class="fas fa-file-import"></i> Importar Backup
                        </button>
                        <input type="file" id="backup-file" accept=".json" style="display: none;">
                    </div>

                    <div id="backup-status" class="backup-status">
                        Último backup: <span id="last-backup-time">Nenhum backup realizado</span>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">Frequência de Backup Automático</label>
                        <select id="backup-frequency" class="form-control">
                            <option value="onchange">A cada alteração</option>
                            <option value="onclose">Ao fechar o sistema</option>
                            <option value="manual">Manual (sem backup automático)</option>
                        </select>
                    </div>
                </div>
            </div>

            
<div id="links-page" class="page" style="display: none;">
    <div class="header">
        <h1 class="page-title">Links Importantes</h1>
        <button id="add-link-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Adicionar Link</button>
    </div>
    <div class="card">
        <h3 class="card-title">Meus Links</h3>
        <table class="table">
            <thead>
                <tr><th>Nome</th><th>URL</th><th>Ações</th></tr>
            </thead>
            <tbody id="links-table"></tbody>
        </table>
    </div>
</div>

<div id="notes-page" class="page" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Minhas Notas</h1>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Escreva suas anotações aqui:</label>
                        <textarea id="notes-content" class="form-control" rows="15" placeholder="Comece a digitar..."></textarea>
                    </div>
                    <div class="modal-footer" style="justify-content: flex-start; padding: 0; border-top: none;">
                         <button id="save-notes" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Notas
                        </button>
                        <button id="print-notes" class="btn btn-secondary">
                             <i class="fas fa-print"></i> Imprimir Notas
                         </button>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <div id="lead-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="lead-modal-title">Novo Cliente</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="lead-form">
                    <input type="hidden" id="lead-id">
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" id="lead-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="lead-email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="tel" id="lead-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Origem</label>
                        <select id="lead-source" class="form-control">
                            <option value="Site">Site</option>
                            <option value="Indicação">Indicação</option>
                            <option value="Redes Sociais">Redes Sociais</option>
                            <option value="Anúncio">Anúncio</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interesse</label>
                        <select id="lead-interest" class="form-control">
                            <option value="Comprar">Comprar</option>
                            <option value="Alugar">Alugar</option>
                            <option value="Vender">Vender</option>
                            <option value="Investir">Investir</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="lead-status" class="form-control">
                            <option value="Novo">Novo</option>
                            <option value="Contatado">Contatado</option>
                            <option value="Interessado">Interessado</option>
                            <option value="Proposta Enviada">Proposta Enviada</option>
                            <option value="Negociação">Negociação</option>
                            <option value="Fechado">Fechado</option>
                            <option value="Perdido">Perdido</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label class="form-label">Documentos</label>
                        <input type="file" id="lead-documents" class="form-control" accept=".pdf, .doc, .docx, .jpg, .png" multiple>
                        <div class="document-preview" id="lead-documents-preview"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea id="lead-notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-lead">Salvar</button>
            </div>
        </div>
    </div>

     <div id="view-lead-modal" class="modal">
        <div class="view-modal-content modal-to-print">
            <div class="modal-header">
                <h3 class="modal-title">Ficha do Cliente</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                 <div class="lead-detail-card">
                     <h3 class="lead-detail-name" id="view-lead-name">Nome do Cliente</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Telefone:</strong> <span id="view-lead-phone"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Email:</strong> <span id="view-lead-email"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Origem:</strong> <span id="view-lead-source"></span>
                        </div>
                         <div class="detail-item">
                            <strong>Interesse:</strong> <span id="view-lead-interest"></span>
                        </div>
                       <div class="detail-item">
                            <strong>Status:</strong> <span id="view-lead-status"></span>
                        </div>
                       <div class="detail-item">
                            <strong>Último Contato:</strong> <span id="view-lead-last-contact"></span>
                        </div>
                    </div>
                     <div class="detail-section">
                        <h4>Documentos</h4>
                        <div class="document-preview" id="view-lead-documents"></div>
                     </div>
                    <div class="detail-section">
                        <h4>Observações</h4>
                        <p id="view-lead-notes"></p>
                    </div>
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
                 <button class="btn btn-primary print-modal" data-modal-id="view-lead-modal"> <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>


    <div id="property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="property-modal-title">Novo Imóvel</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="property-form">
                    <input type="hidden" id="property-id">
                     <div class="form-group">
                        <label class="form-label">Nome do Imóvel</label>
                        <input type="text" id="property-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Código</label>
                        <input type="text" id="property-code" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select id="property-type" class="form-control">
                            <option value="Casa">Casa</option>
                            <option value="Apartamento">Apartamento</option>
                            <option value="Terreno">Terreno</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Rural">Rural</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endereço</label>
                        <input type="text" id="property-address" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bairro</label>
                        <input type="text" id="property-neighborhood" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cidade</label>
                        <input type="text" id="property-city" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <input type="text" id="property-state" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preço (R$)</label>
                        <input type="number" id="property-price" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Área (m²)</label>
                        <input type="number" id="property-area" class="form-control" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quartos</label>
                        <input type="number" id="property-bedrooms" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Banheiros</label>
                        <input type="number" id="property-bathrooms" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vagas</label>
                        <input type="number" id="property-parking" class="form-control">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Estoque</label>
                        <input type="number" id="property-stock" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="property-status" class="form-control">
                            <option value="Disponível">Disponível</option>
                            <option value="Reservado">Reservado</option>
                            <option value="Vendido">Vendido</option>
                            <option value="Alugado">Alugado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea id="property-description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imagens</label>
                        <input type="file" id="property-images" class="form-control" accept="image/*" multiple>
                        <div class="image-gallery" id="property-images-preview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-property">Salvar</button>
            </div>
        </div>
    </div>

     <div id="view-property-modal" class="modal">
        <div class="view-modal-content modal-to-print">
            <div class="modal-header">
                <h3 class="modal-title">Ficha do Imóvel</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                 <div class="property-detail-card" data-property-id="">
                     <h3 class="property-detail-name" id="view-property-name">Nome do Imóvel</h3>
                     <div class="detail-section">
                         <h4>Localização e Identificação</h4>
                         <div class="detail-grid">
                           <div class="detail-item">
                                <strong>Código:</strong> <span id="view-property-code"></span>
                            </div>
                           <div class="detail-item">
                                 <strong>Endereço:</strong> <span id="view-property-address"></span>
                            </div>
                           <div class="detail-item">
                                <strong>Bairro:</strong> <span id="view-property-neighborhood"></span>
                            </div>
                           <div class="detail-item">
                                <strong>Cidade:</strong> <span id="view-property-city"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Estado:</strong> <span id="view-property-state"></span>
                            </div>
                         </div>
                    </div>


                     <div class="detail-section">
                        <h4>Detalhes Principais</h4>
                         <div class="detail-grid">
                           <div class="detail-item">
                                <strong>Tipo:</strong> <span id="view-property-type"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Valores a Partir de:</strong> <span id="view-property-price"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Status:</strong> <span id="view-property-status"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Estoque:</strong> <span id="view-property-stock">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                         <h4>Características</h4>
                         <div class="detail-grid">
                              <div class="detail-item">
                                <strong>Área (m²):</strong> <span id="view-property-area"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Quartos:</strong> <span id="view-property-bedrooms"></span>
                            </div>
                             <div class="detail-item">
                                <strong>Banheiros:</strong> <span id="view-property-bathrooms"></span>
                            </div>
                            <div class="detail-item">
                                <strong>Vagas:</strong> <span id="view-property-parking"></span>
                            </div>
                         </div>
                     </div>

                    <div class="detail-section">
                        <h4>Descrição</h4>
                        <p id="view-property-description"></p>
                    </div>

                    <div class="detail-section">
                        <h4>Imagens</h4>
                        <div class="image-gallery" id="view-property-images-preview"></div>
                    </div>
                 </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
                 <button class="btn btn-primary print-modal" data-modal-id="view-property-modal"> <i class="fas fa-print"></i> Imprimir
                </button>
                 <button class="btn btn-success" id="download-property-pdf">
                    <i class="fas fa-download"></i> Baixar PDF
                </button>
            </div>
        </div>
    </div>


    <div id="appointment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="appointment-modal-title">Novo Agendamento</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <input type="hidden" id="appointment-id">
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <select id="appointment-lead" class="form-control" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imóvel</label>
                        <select id="appointment-property" class="form-control" required>
                            <option value="">Selecione um imóvel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" id="appointment-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" id="appointment-time" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select id="appointment-type" class="form-control">
                            <option value="Visita">Visita</option>
                            <option value="Reunião">Reunião</option>
                            <option value="Assinatura">Assinatura</option>
                            <option value="Outro">Outro</option>
                            <option value="Plantão">Plantão</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="appointment-status" class="form-control">
                            <option value="Agendado">Agendado</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Realizado">Realizado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea id="appointment-notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-appointment">Salvar</button>
            </div>
        </div>
    </div>

     <div id="view-appointment-modal" class="modal">
        <div class="view-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes do Agendamento</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                 <div class="appointment-detail-card">
                     <h3 class="appointment-detail-title" id="view-appointment-title">Agendamento</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Data e Hora:</strong> <span id="view-appointment-datetime"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Tipo:</strong> <span id="view-appointment-type"></span>
                        </div>
                         <div class="detail-item">
                            <strong>Status:</strong> <span id="view-appointment-status"></span>
                        </div>
                        <div class="detail-item" id="view-appointment-client-item">
                            <strong>Cliente:</strong> <span id="view-appointment-client"></span>
                        </div>
                        <div class="detail-item" id="view-appointment-property-item">
                            <strong>Imóvel:</strong> <span id="view-appointment-property"></span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4>Observações</h4>
                        <p id="view-appointment-notes"></p>
                    </div>
                 </div>
            </div>
             <div class="modal-footer">
                <button class="btn btn-success" id="mark-appointment-completed-btn">
                    <i class="fas fa-check-circle"></i> Marcar como Concluído
                </button>
                <button class="btn btn-primary" id="edit-viewed-appointment-btn">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>


    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    <input type="hidden" id="transaction-id">
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select id="transaction-type" class="form-control" required>
                            <option value="income">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select id="transaction-category" class="form-control" required>
                            <option value="venda">Venda</option>
                            <option value="aluguel">Aluguel</option>
                            <option value="comissão">Comissão</option>
                            <option value="manutenção">Manutenção</option>
                            <option value="marketing">Marketing</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <input type="text" id="transaction-description" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor (R$)</label>
                        <input type="number" id="transaction-amount" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" id="transaction-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Forma de Pagamento</label>
                        <select id="transaction-payment" class="form-control">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão">Cartão</option>
                            <option value="Transferência">Transferência</option>
                            <option value="Boleto">Boleto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea id="transaction-notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-transaction">Salvar</button>
            </div>
        </div>
    </div>

    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Recibo</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="receipt-container">
                    <div class="receipt-header">
                        <h3 class="receipt-title" id="receipt-company-name">MEU CRM</h3>
                        <p>CNPJ: 00.000.000/0001-00</p>
                        <p>Endereço: Rua Exemplo, 123 - Centro</p>
                    </div>

                    <div class="receipt-details">
                        <div class="receipt-row">
                            <span class="receipt-label">Recibo Nº:</span>
                            <span id="receipt-number">0001</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Data:</span>
                            <span id="receipt-date">01/01/2023</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Recebemos de:</span>
                            <span id="receipt-from">Cliente Exemplo</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">CPF/CNPJ:</span>
                            <span id="receipt-document">000.000.000-00</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Referente a:</span>
                            <span id="receipt-reference">Comissão de venda do imóvel XYZ</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Valor:</span>
                            <span id="receipt-amount">R$ 1.000,00</span>
                        </div>
                        <div class="receipt-row">
                            <span class="receipt-label">Forma de Pagamento:</span>
                            <span id="receipt-payment">Transferência Bancária</span>
                        </div>
                    </div>

                    <div class="receipt-footer">
                        <p>_________________________________________</p>
                        <p>Assinatura</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
                <button class="btn btn-primary" id="print-receipt">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn btn-success" id="download-receipt">
                    <i class="fas fa-download"></i> Baixar PDF
                </button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="user-modal-title">Novo Usuário</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" id="user-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="user-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" id="user-password" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirmar Senha</label>
                        <input type="password" id="user-confirm-password" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Perfil</label>
                        <select id="user-role" class="form-control">
                            <option value="admin">Administrador</option>
                            <option value="corretor">Corretor</option>
                            <option value="assistente">Assistente</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-user">Salvar</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Acesso ao CRM</h3>
            </div>
            <div class="modal-body">
                <form id="password-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="login-btn">Entrar</button>
            </div>
        </div>
    </div>

    <div id="confirmation-dialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 id="confirmation-title">Confirmar ação</h3>
            <p id="confirmation-message">Tem certeza que deseja realizar esta ação?</p>
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="cancel-confirmation">Cancelar</button>
                <button class="btn btn-danger" id="confirm-action">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="appointment-alert" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Atenção: Agendamentos Pendentes!</h3>
                <span class="close-alert" onclick="hideAppointmentAlert()">&times;</span>
            </div>
            <div class="modal-body" id="appointment-alert-body">
                </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAppointmentAlert()">Fechar</button>
            </div>
        </div>
    </div>

    <div id="image-viewer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <img id="fullscreen-image" src="" alt="Imagem em tela cheia">
            </div>
            <div class="modal-footer">
                <button id="prev-image-btn"><i class="fas fa-chevron-left"></i></button>
                <span id="image-counter"></span>
                <button id="next-image-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script>
        // Dados do CRM
        let leads = [];
        let properties = [];
        let appointments = [];
        let transactions = [];
        let users = [];
        let settings = {
            siteUrl: 'https://sistemasupremo.com.br/login/',
            crmPassword: 'admin123',
            logo: '',
            banner: '',
            companyName: 'MEU CRM',
            autoSync: 'enabled',
            siteTitle: 'MEU CRM',
            backupFrequency: 'onchange',
            lastBackup: null
        };
        // Estado da aplicação
        let propertyImages = [];
        let leadDocuments = [];
        // New: Array to store lead documents
        let currentUser = null;
        const { jsPDF } = window.jspdf;
        const BACKUP_KEY = 'crm_imobiliario_last_backup';
        let backupTimer = null;
        // Variável para armazenar o histórico de importações
        let importHistory = JSON.parse(localStorage.getItem('importHistory')) || [];

        // Variáveis para o visualizador de imagens
        let currentImageViewerImages = [];
        let currentImageViewerIndex = 0;


        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            updateUI();
            showPasswordModal();
            initModules();
            setupAppointmentTypeListener(); // Setup the new listener

            // Add the appointment alert check here
            showAppointmentAlerts();
        });
        // =============================================
        // MÓDULOS ADICIONAIS
        // =============================================

        function initModules() {
            if (document.getElementById('marketing-page')) {
                initMarketingModule();
            }
            fixCompanyNameSaving();
            // Inicializa calendário se estiver na página de agenda
            if (document.getElementById('appointments-page')) {
                initCalendar();
            }
             setupPrintButtons();
             // Setup print button listeners
        }

        function initMarketingModule() {
            const container = document.getElementById('marketing-container');
            container.innerHTML = `
                <div class="property-selector">
                    <h3>Selecione um Imóvel para Anúncio</h3>
                    <select id="property-select" class="form-control">
                        ${properties.map(p => `
                            <option value="${p.id}">${p.code} - ${p.type} - ${p.neighborhood}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="ad-preview mt-4">
                    <h3>Pré-visualização do Anúncio</h3>
                    <div id="ad-preview-container"></div>
                    <button id="share-whatsapp" class="btn btn-success mt-3">
                        <i class="fab fa-whatsapp"></i> Compartilhar no WhatsApp
                    </button>
                </div>
            `;
            document.getElementById('property-select').addEventListener('change', updateAdPreview);
            document.getElementById('share-whatsapp').addEventListener('click', shareOnWhatsApp);

            updateAdPreview();
        }

        function updateAdPreview() {
            const propertyId = parseInt(document.getElementById('property-select').value);
            const property = properties.find(p => p.id === propertyId);

            const previewHTML = `
                <div class="property-ad-card">
                    <img src="${property.images?.[0] || 'placeholder.jpg'}"
                         alt="${property.type} em ${property.neighborhood}"
                         class="property-ad-image">
                    <div class="property-ad-content">
                         <h4>${property.name || property.address}</h4>
                         <p>${property.type} para ${property.interest === 'Alugar' ? 'Aluguel' : 'Venda'}</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${property.neighborhood}, ${property.city}</p>
                        <p><strong>${formatCurrency(property.price)}</strong></p>
                        <p>${property.area}m² | ${property.bedrooms} quartos | ${property.bathrooms} banheiros</p>
                        <p class="description">${property.description || 'Ótimo imóvel em ótima localização'}</p>
                        <p class="contact">Contato: ${currentUser?.phone || ''}</p>
                    </div>
                </div>
            `;
            document.getElementById('ad-preview-container').innerHTML = previewHTML;
        }

        function fixCompanyNameSaving() {
            document.getElementById('save-branding').addEventListener('click', function() {
                const newName = document.getElementById('company-name').value;
                settings.companyName = newName;
                document.querySelectorAll('.logo h2').forEach(el => {
                    el.textContent = newName;
                });
                saveData();
                alert('Configurações salvas com sucesso!');
            });
        }

        function initCalendar() {
            // Implementação do calendário pode ser adicionada aqui
        }

        function setupPrintButtons() {
            document.querySelectorAll('.print-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal-id');
                    printModalContent(modalId);
                });
            });
        }

        function printModalContent(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) {
                console.error("Modal element not found:", modalId);
                return;
            }

            // Add a class to the modal for print styling
            modalElement.classList.add('modal-to-print');
            // Use a timeout to allow the class to be applied before printing
            setTimeout(() => {
                 window.print();

                 // Remove the print class after printing (or print dialog is closed)
                 setTimeout(() => {
                    modalElement.classList.remove('modal-to-print');
                 }, 500); // Small delay
            }, 500); // Small delay
        }



        // =============================================
        // SISTEMA DE BACKUP AUTOMÁTICO
        // =============================================

        function setupAutoBackup() {
            // Carrega configuração de frequência de backup
            if (localStorage.getItem('settings')) {
                const savedSettings = JSON.parse(localStorage.getItem('settings'));
                if (savedSettings.backupFrequency) {
                    settings.backupFrequency = savedSettings.backupFrequency;
                    document.getElementById('backup-frequency').value = settings.backupFrequency;
                }
            }

            // Atualiza status do último backup
            updateBackupStatus();
            // Configura o backup automático baseado na frequência selecionada
            configureBackupFrequency();
        }

        function configureBackupFrequency() {
            // Limpa qualquer timer existente
            if (backupTimer) {
                clearTimeout(backupTimer);
                backupTimer = null;
            }

            // Configura de acordo com a frequência selecionada
            switch(settings.backupFrequency) {
                case 'onchange':
                    // Backup é feito automaticamente pelo saveData()
                    break;
                case 'onclose':
                    window.addEventListener('beforeunload', handleBeforeUnload);
                    break;

                case 'manual':
                    // Nada a fazer, backup apenas manual
                    break;
            }

            // Atualiza a exibição do status
            updateBackupStatus();
        }

        function handleBeforeUnload(e) {
            // Exporta backup quando a página está sendo fechada
            exportBackupToFile();
        }

        function updateBackupStatus() {
            const statusElement = document.getElementById('backup-status');
            const timeElement = document.getElementById('last-backup-time');

            if (settings.lastBackup) {
                const lastBackupDate = new Date(settings.lastBackup);
                timeElement.textContent = lastBackupDate.toLocaleString();
                statusElement.className = 'backup-status success';
            } else {
                timeElement.textContent = 'Nenhum backup realizado';
                statusElement.className = 'backup-status';
            }

            // Atualiza a frequência exibida
            document.getElementById('backup-frequency').value = settings.backupFrequency;
        }

        function exportBackupToFile() {
            try {
                const backupData = getAllDataForBackup();
                const dataStr = JSON.stringify(backupData, null, 2);

                // Cria um blob com os dados
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // Cria um link temporário para download
                const a = document.createElement('a');
                a.href = url;
                a.download = generateBackupFilename();

                // Dispara o download automaticamente
                document.body.appendChild(a);
                a.click();

                // Limpa o objeto URL
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                // Atualiza a data do último backup
                settings.lastBackup = new Date().toISOString();
                localStorage.setItem('settings', JSON.stringify(settings));

                // Armazena o nome do último backup para recuperação
                localStorage.setItem(BACKUP_KEY, a.download);
                // Atualiza o status
                updateBackupStatus();
                return true;
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                alert('Erro ao exportar backup. Por favor, tente novamente.');
                return false;
            }
        }

        function getAllDataForBackup() {
            return {
                leads: leads,
                properties: properties,
                appointments: appointments,
                transactions: transactions,
                users: users,
                settings: settings,
                importHistory: importHistory, // Incluir histórico de importação
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
        }

        function generateBackupFilename() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            return `crm_backup_${dateStr}_${timeStr}.json`;
        }

        function importBackup(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData.leads || !backupData.properties || !backupData.appointments || !backupData.transactions) {
                        throw new Error('Formato de backup inválido');
                    }

                    showConfirmationDialog(
                        'Importar Backup',
                        'Isso substituirá todos os dados atuais. Deseja continuar?',
                        function() {
                            leads = backupData.leads || [];
                            properties = backupData.properties || [];
                            appointments = backupData.appointments || [];
                            transactions = backupData.transactions || [];
                            users = backupData.users || [];
                            importHistory = backupData.importHistory || []; // Importar histórico


                            // Atualiza a data do último backup
                            settings.lastBackup = new Date().toISOString();
                            localStorage.setItem('settings', JSON.stringify(settings));
                            localStorage.setItem(BACKUP_KEY, file.name);

                            // Salva os dados importados
                            saveData();
                            updateUI();
                            updateBackupStatus();

                            alert('Backup importado com sucesso!');
                        }
                    );
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    alert('Erro ao importar backup. Arquivo inválido ou corrompido.');
                }
            };
            reader.readAsText(file);
        }

        // =============================================
        // FUNÇÕES PRINCIPAIS DO CRM
        // =============================================

        function loadData() {
            // Tenta carregar do localStorage primeiro
            leads = JSON.parse(localStorage.getItem('leads')) || [];
            properties = JSON.parse(localStorage.getItem('properties')) || [];
            appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            users = JSON.parse(localStorage.getItem('users')) || [];
            importHistory = JSON.parse(localStorage.getItem('importHistory')) || []; // Carregar histórico
            const savedSettings = JSON.parse(localStorage.getItem('settings'));

            if (savedSettings) {
                settings = {...settings, ...savedSettings};
            }

            // Se não houver usuários, cria um admin padrão
            if (users.length === 0) {
                users.push({
                    id: 1,
                    name: 'Administrador',
                    email: 'admin@imobiliaria.com',
                    password: 'admin123',
                    role: 'admin'
                });
                saveData();
            }

            // Atualiza logo se existir
            if (settings.logo) {
                document.getElementById('crm-logo').src = settings.logo;
            }
        }

        function saveData() {
            try {
                localStorage.setItem('leads', JSON.stringify(leads));
                localStorage.setItem('properties', JSON.stringify(properties));
                localStorage.setItem('appointments', JSON.stringify(appointments));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('settings', JSON.stringify(settings));
                localStorage.setItem('importHistory', JSON.stringify(importHistory)); // Salvar histórico
                // Executa backup automático se configurado
                if (settings.backupFrequency === 'onchange') {
                    exportBackupToFile();
                }

                return true;
            } catch (e) {
                console.error('Erro ao salvar dados:', e);
                // Se der erro por limite de espaço, tenta apenas o backup em arquivo
                try {
                    exportBackupToFile();
                    return true;
                } catch (e2) {
                    alert('Erro ao salvar dados. Por favor, exporte manualmente um backup.');
                    return false;
                }
            }
        }

        function clearAllData() {
            showConfirmationDialog(
                'Limpar Todos os Dados',
                'Tem certeza que deseja apagar TODOS os dados? Esta ação não pode ser desfeita.',
                function() {
                    leads = [];
                    properties = [];
                    appointments = [];
                    transactions = [];
                    importHistory = []; // Limpar histórico

                    saveData();
                    updateUI();
                    alert('Todos os dados foram removidos.');
                }
            );
        }

        function updateUI() {
            // Atualiza estatísticas
            updateStats();
            // Atualiza tabelas
            updateRecentLeadsTable();
            updateAllLeadsTable();
            updateRecentPropertiesTable();
            updateAllPropertiesTable();
            updateAppointmentsTable();
            updateTransactionsTable();
            updateUsersTable();
            updateFunnel();
            updateImportHistory(); // Atualizar histórico de importações


            // Atualiza gráficos
            updateCharts();
            // Novas inicializações
            if (document.getElementById('financial-page').style.display !== 'none') {
                setupFinancialFilters();
            }
            if (document.getElementById('properties-page').style.display !== 'none') {
                setupPropertyFilters();
            }
            if (document.getElementById('leads-page').style.display !== 'none') {
                setupLeadStatusFilter();
            }
        }

        function updateStats() {
            // Clientes
            const activeLeads = leads.filter(lead => lead.status !== 'Fechado' && lead.status !== 'Perdido').length;
            document.getElementById('active-leads-count').textContent = activeLeads;
            document.getElementById('total-leads-count').textContent = leads.length;

            // Imóveis
            const availableProperties = properties.filter(prop => prop.status === 'Disponível').length;
            document.getElementById('available-properties-count').textContent = availableProperties;
            document.getElementById('total-properties-count').textContent = properties.length;

            // Agendamentos
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const todayAppointments = appointments.filter(app => {
                // Exclui agendamentos com status 'Realizado' ou 'Cancelado'
                if (app.status === 'Realizado' || app.status === 'Cancelado') {
                    return false;
                }
                const appDate = new Date(`${app.date}T${app.time || '00:00'}`);
                // Inclui agendamentos que são hoje e ainda não passaram do horário
                // Ou agendamentos com data no passado (que são considerados pendentes até serem marcados como Realizado/Cancelado)
                 return appDate.toISOString().split('T')[0] === today || appDate < now;
            }).length;
            document.getElementById('today-appointments-count').textContent = todayAppointments;
            document.getElementById('total-appointments-count').textContent = appointments.length;

            // Adiciona/remove classe de piscar se houver agendamentos atrasados/hoje
            const appointmentCard = document.querySelector('.stat-card:nth-child(3)');
            if (todayAppointments > 0) {
                appointmentCard.classList.add('blink');
            } else {
                appointmentCard.classList.remove('blink');
            }

            // Financeiro
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthlyIncome = transactions
                .filter(t => t.type === 'income' &&
                    new Date(t.date).getMonth() + 1 === currentMonth &&
                    new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            document.getElementById('monthly-revenue').textContent = formatCurrency(monthlyIncome);
            document.getElementById('total-revenue').textContent = formatCurrency(totalIncome);

            // Financeiro - página financeira
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('current-balance').textContent = formatCurrency(totalIncome - totalExpenses);
        }

        function formatCurrency(value) {
            return 'R$ ' + parseFloat(value || 0).toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateString, timeString) {
            if (!dateString) return '';
            const date = new Date(`${dateString}T${timeString || '00:00'}`);
            return date.toLocaleString('pt-BR');
        }

        function updateRecentLeadsTable() {
            const table = document.getElementById('recent-leads-table');
            table.innerHTML = '';

            // Ordena leads por data de último contato (más recentes primeiro)
            const sortedLeads = [...leads].sort((a, b) => {
                return new Date(b.lastContact || b.createdAt) - new Date(a.lastContact || a.createdAt);
            }).slice(0, 5);
            // Pega apenas os 5 mais recentes

            sortedLeads.forEach(lead => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.phone}</td>
                    <td>${lead.interest}</td>
                    <td><span class="badge ${getStatusBadgeClass(lead.status)}">${lead.status}</span></td>
                    <td>${formatDate(lead.lastContact)}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewLead(${lead.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editLead(${lead.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteLead(${lead.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function updateAllLeadsTable(statusFilter = '') {
            const table = document.getElementById('all-leads-table');
            table.innerHTML = '';

            let filteredLeads = [...leads];
            if (statusFilter) {
                filteredLeads = filteredLeads.filter(lead => lead.status === statusFilter);
            }

            filteredLeads.forEach(lead => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.phone}</td>
                    <td>${lead.interest}</td>
                    <td>${lead.source}</td>
                    <td><span class="badge ${getStatusBadgeClass(lead.status)}">${lead.status}</span></td>
                    <td>${formatDate(lead.lastContact)}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewLead(${lead.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editLead(${lead.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteLead(${lead.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function setupLeadStatusFilter() {
            const filterHTML = `
                <div class="filters">
                    <select id="lead-status-filter" class="form-control">
                        <option value="">Todos os status</option>
                        <option value="Novo">Novo</option>
                        <option value="Contatado">Contatado</option>
                        <option value="Interessado">Interessado</option>
                        <option value="Proposta Enviada">Proposta Enviada</option>
                        <option value="Negociação">Negociação</option>
                        <option value="Fechado">Fechado</option>
                        <option value="Perdido">Perdido</option>
                    </select>
                </div>
            `;
            // Check if filter already exists to prevent duplication
            if (!document.getElementById('lead-status-filter')) {
                 document.getElementById('leads-page').insertAdjacentHTML('afterbegin', filterHTML);
                 document.getElementById('lead-status-filter').addEventListener('change', function() {
                    const status = this.value;
                    updateAllLeadsTable(status);
                });
            }
        }

        function updateRecentPropertiesTable() {
            const table = document.getElementById('recent-properties-table');
            table.innerHTML = '';

            // Ordena propriedades por data de criação (mais recentes primeiro)
            const sortedProperties = [...properties].sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            }).slice(0, 5);
            // Pega apenas os 5 mais recentes

            sortedProperties.forEach(property => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${property.code}</td>
                    <td>${property.name || '-'}</td>
                    <td>${property.type}</td>
                    <td>${property.address}</td>
                    <td>${formatCurrency(property.price)}</td>
                    <td><span class="badge ${getStatusBadgeClass(property.status)}">${property.status}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewProperty(${property.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProperty(${property.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function updateAllPropertiesTable() {
            const table = document.getElementById('all-properties-table');
            table.innerHTML = '';

            properties.forEach(property => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${property.code}</td>
                    <td>${property.name || '-'}</td>
                    <td>${property.type}</td>
                    <td>${property.address}</td>
                    <td>${formatCurrency(property.price)}</td>
                    <td>${property.area || '-'}</td>
                    <td><span class="badge ${getStatusBadgeClass(property.status)}">${property.status}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewProperty(${property.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProperty(${property.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function setupPropertyFilters() {
            const filtersHTML = `
                <div class="filters">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Preço</label>
                            <select id="price-filter" class="form-control">
                                <option value="">Todos</option>
                                <option value="0-500000">Até R$ 500 mil</option>
                                <option value="500000-1000000">R$ 500 mil - 1 milhão</option>
                                <option value="1000000-2000000">R$ 1 milhão - 2 milhões</option>
                                <option value="2000000-">Acima de R$ 2 milhões</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Tipo</label>
                            <select id="type-filter" class="form-control">
                                <option value="">Todos</option>
                                ${[...new Set(properties.map(p => p.type))].map(t =>
                                    `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Bairro</label>
                            <select id="neighborhood-filter" class="form-control">
                                <option value="">Todos</option>
                                ${[...new Set(properties.map(p => p.neighborhood))].map(n =>
                                    `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
            // Check if filter already exists to prevent duplication
            if (!document.getElementById('price-filter')) {
                document.getElementById('properties-page').insertAdjacentHTML('afterbegin', filtersHTML);
                // Event listeners para os filtros
                ['price-filter', 'type-filter', 'neighborhood-filter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', filterProperties);
                });
            }
        }

        function filterProperties() {
            const priceRange = document.getElementById('price-filter').value;
            const type = document.getElementById('type-filter').value;
            const neighborhood = document.getElementById('neighborhood-filter').value;

            let filtered = [...properties];
            if (priceRange) {
                const [min, max] = priceRange.split('-').map(Number);
                if (min && max) {
                    filtered = filtered.filter(p => p.price >= min && p.price <= max);
                } else if (min) {
                    filtered = filtered.filter(p => p.price >= min);
                } else if (max) {
                    filtered = filtered.filter(p => p.price <= max);
                }
            }

            if (type) filtered = filtered.filter(p => p.type === type);
            if (neighborhood) filtered = filtered.filter(p => p.neighborhood === neighborhood);

            renderPropertiesTable(filtered);
        }

        function renderPropertiesTable(filteredProperties) {
            const table = document.getElementById('all-properties-table');
            table.innerHTML = '';

            filteredProperties.forEach(property => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${property.code}</td>
                     <td>${property.name || '-'}</td>
                     <td>${property.type}</td>
                    <td>${property.address}</td>
                    <td>${formatCurrency(property.price)}</td>
                    <td>${property.area || '-'}</td>
                    <td><span class="badge ${getStatusBadgeClass(property.status)}">${property.status}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewProperty(${property.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProperty(${property.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function updateAppointmentsTable() {
            const table = document.getElementById('appointments-table');
            table.innerHTML = '';

            // Ordena agendamentos por data/hora (mais próximos primeiro)
            const sortedAppointments = [...appointments].sort((a, b) => {
                return new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`);
            });
            sortedAppointments.forEach(appointment => {
                const lead = leads.find(l => l.id === appointment.leadId) || { name: 'Cliente não informado' }; // Updated text
                const property = properties.find(p => p.id === appointment.propertyId) || { code: 'Imóvel não informado' }; // Updated text

                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${formatDateTime(appointment.date, appointment.time)}</td>
                    <td>${appointment.type === 'Plantão' ? '-' : lead.name}</td> // Display '-' for Plantão
                    <td>${appointment.type === 'Plantão' ? '-' : property.code}</td> // Display '-' for Plantão
                    <td>${appointment.type}</td>
                    <td><span class="badge ${getStatusBadgeClass(appointment.status)}">${appointment.status}</span></td>
                    <td>
                         <button class="btn btn-info btn-sm" onclick="viewAppointment(${appointment.id});">
                         <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editAppointment(${appointment.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAppointment(${appointment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function viewAppointment(id) {
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;

            const lead = leads.find(l => l.id === appointment.leadId) || { name: 'Não informado' };
            const property = properties.find(p => p.id === appointment.propertyId) || { code: 'Não informado' };

            document.getElementById('view-appointment-title').textContent = `Detalhes do Agendamento #${appointment.id}`;
            document.getElementById('view-appointment-datetime').textContent = formatDateTime(appointment.date, appointment.time);
            document.getElementById('view-appointment-type').textContent = appointment.type || 'Não informado';
            document.getElementById('view-appointment-status').textContent = appointment.status || 'Não informado';
            document.getElementById('view-appointment-notes').textContent = appointment.notes || 'Nenhuma observação.';

            // Conditionally display Client and Property based on type
            const clientItem = document.getElementById('view-appointment-client-item');
            const propertyItem = document.getElementById('view-appointment-property-item');

            if (appointment.type === 'Plantão') {
                clientItem.style.display = 'none';
                propertyItem.style.display = 'none';
            } else {
                clientItem.style.display = 'block';
                propertyItem.style.display = 'block';
                document.getElementById('view-appointment-client').textContent = lead.name;
                document.getElementById('view-appointment-property').textContent = property.code;
            }

            // Adiciona lógica para o botão "Marcar como Concluído"
            const markCompletedBtn = document.getElementById('mark-appointment-completed-btn');
            if (markCompletedBtn) {
                 // Remove any existing listener to prevent duplicates
                 const oldBtn = markCompletedBtn.cloneNode(true);
                 markCompletedBtn.parentNode.replaceChild(oldBtn, markCompletedBtn);
                 const newMarkCompletedBtn = document.getElementById('mark-appointment-completed-btn');

                // Add the new listener with the current appointment ID
                newMarkCompletedBtn.onclick = function() {
                    markAppointmentAsCompleted(appointment.id);
                };

                // Optionally hide the button if status is already 'Realizado' or 'Cancelado'
                if (appointment.status === 'Realizado' || appointment.status === 'Cancelado') {
                    newMarkCompletedBtn.style.display = 'none';
                } else {
                    newMarkCompletedBtn.style.display = 'inline-block'; // Or 'block' depending on your layout
                }
            }

            // Adiciona lógica para o botão "Editar"
            const editButton = document.getElementById('edit-viewed-appointment-btn');
            if (editButton) {
                // Remove any existing listener to prevent duplicates
                const oldEditBtn = editButton.cloneNode(true);
                editButton.parentNode.replaceChild(oldEditBtn, editButton);
                const newEditButton = document.getElementById('edit-viewed-appointment-btn');

                newEditButton.onclick = function() {
                    hideModal('view-appointment-modal'); // Esconde o modal de visualização
                    editAppointment(appointment.id); // Chama a função de edição
                     // Navega para a página de agendamentos (opcional, se já não estiver lá)
                    const appointmentsMenuItem = document.querySelector('.menu-item[data-page="appointments"]');
                    if (appointmentsMenuItem && !appointmentsMenuItem.classList.contains('active')) {
                        appointmentsMenuItem.click(); // Simula o clique no item do menu
                    } else if (!appointmentsMenuItem) {
                         // Fallback if menu item not found (less likely in this structure)
                        showPage('appointments');
                    }
                };
            }


            showModal('view-appointment-modal');
        }


        function setupAppointmentTypeListener() {
             const appointmentTypeSelect = document.getElementById('appointment-type');
             const leadField = document.getElementById('appointment-lead');
             const propertyField = document.getElementById('appointment-property');
             const leadFormGroup = leadField?.closest('.form-group');
             const propertyFormGroup = propertyField?.closest('.form-group');

             if (!appointmentTypeSelect || !leadField || !propertyField || !leadFormGroup || !propertyFormGroup) {
                console.error("Appointment form elements not found.");
                return;
            }

             appointmentTypeSelect.addEventListener('change', function() {
                 if (this.value === 'Plantão') {
                     leadField.removeAttribute('required');
                     propertyField.removeAttribute('required');
                     leadFormGroup.style.display = 'none'; // Optional: hide the fields
                     propertyFormGroup.style.display = 'none'; // Optional: hide the fields
                 } else {
                     leadField.setAttribute('required', 'required');
                     propertyField.setAttribute('required', 'required');
                     leadFormGroup.style.display = 'block'; // Optional: show the fields
                     propertyFormGroup.style.display = 'block'; // Optional: show the fields
                 }
             });
             // Also trigger on page load to set initial state
              appointmentTypeSelect.dispatchEvent(new Event('change'));
        }


        function updateTransactionsTable(filter = 'all') {
            const table = document.getElementById('transactions-table');
            table.innerHTML = '';

            let filteredTransactions = [...transactions];

            if (filter === 'income') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'income');
            } else if (filter === 'expense') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'expense');
            } else if (filter === 'venda') {
                filteredTransactions = filteredTransactions.filter(t => t.category === 'venda');
            } else if (filter === 'aluguel') {
                filteredTransactions = filteredTransactions.filter(t => t.category === 'aluguel');
            }

            // Ordena transações por data (más recentes primeiro)
            filteredTransactions.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description}</td>
                    <td>${transaction.category}</td>
                    <td>${formatCurrency(transaction.amount)}</td>
                    <td><span class="badge ${transaction.type === 'income' ? 'badge-success' : 'badge-danger'}">${transaction.type === 'income' ? 'Receita' : 'Despesa'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editTransaction(${transaction.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function setupFinancialFilters() {
            const filtersHTML = `
                <div class="filters">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Período</label>
                            <select id="period-filter" class="form-control">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30" selected>Últimos 30 dias</option>
                                <option value="90">Últimos 3 meses</option>
                                <option value="365">Último ano</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Tipo</label>
                            <select id="transaction-type-filter" class="form-control">
                                <option value="all">Todos</option>
                                <option value="income">Receitas</option>
                                <option value="expense">Despesas</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            // Check if filter already exists to prevent duplication
            if (!document.getElementById('period-filter')) {
                 document.getElementById('financial-page').insertAdjacentHTML('afterbegin', filtersHTML);
                // Event listeners
                document.getElementById('period-filter').addEventListener('change', updateFinancialCharts);
                document.getElementById('transaction-type-filter').addEventListener('change', updateFinancialCharts);
                // Inicializa gráfico
                updateFinancialCharts();
            }
        }

        function updateFinancialCharts() {
            const period = parseInt(document.getElementById('period-filter').value);
            const type = document.getElementById('transaction-type-filter').value;

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - period);
            let filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            if (type !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === type);
            }

            renderTowerChart(filteredTransactions);
        }

        function renderTowerChart(filteredTransactions) {
            // Implementação do gráfico em torre pode ser adicionada aqui
        }

        function updateUsersTable() {
            const table = document.getElementById('users-table');
            table.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-primary' : 'badge-secondary'}">${user.role === 'admin' ? 'Administrador' : user.role === 'corretor' ? 'Corretor' : 'Assistente'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                table.appendChild(row);
            });
        }

        function updateFunnel() {
            const statuses = {
                "Novo": "new-leads-list",
                "Contatado": "contacted-leads-list",
                "Interessado": "interested-leads-list",
                "Proposta Enviada": "proposal-leads-list",
                "Negociação": "negotiation-leads-list",
                "Fechado": "closed-leads-list"
            };
            for (let status in statuses) {
                const container = document.getElementById(statuses[status]);
                if (!container) continue;
                const filtered = leads.filter(lead => lead.status === status);
                container.innerHTML = '';
                const countEl = document.getElementById(statuses[status].replace('-list', '-count'));
                if (countEl) countEl.textContent = filtered.length;

                filtered.forEach(lead => {
                    const div = document.createElement('div');
                    div.className = 'funnel-lead';
                    // Add data-id for easier lookup
                    div.setAttribute('data-id', lead.id);

                    div.innerHTML = `
                        <span class="funnel-lead-name">${lead.name}</span>
                        <div class="funnel-lead-actions">
                            ${lead.status !== 'Fechado' ? `
                            <button class="btn btn-success btn-sm" onclick="moveLeadToNextStage(${lead.id})">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="viewLead(${lead.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editLead(${lead.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function updateCharts() {
            // Gráfico de leads por origem
            const sourceCtx = document.getElementById('sourceChart')?.getContext('2d');
            if (sourceCtx) {
                const sources = {};

                leads.forEach(lead => {
                    sources[lead.source] = (sources[lead.source] || 0) + 1;
                });
                // Destroy existing chart instance if it exists
                if (window.sourceChartInstance) {
                    window.sourceChartInstance.destroy();
                }
                window.sourceChartInstance = new Chart(sourceCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(sources),
                        datasets: [{
                            data: Object.values(sources),
                            backgroundColor: [
                                '#3498db',
                                '#2ecc71',
                                '#f39c12',
                                '#e74c3c',
                                '#9b59b6'
                            ]
                        }]
                    }
                });
            }


            // Gráfico de vendas por mês
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
             if(salesCtx) {
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dec'];
                const salesData = new Array(12).fill(0);
                transactions
                    .filter(t => t.type === 'income' && t.category === 'venda')
                    .forEach(t => {
                        const month = new Date(t.date).getMonth();
                        salesData[month] += parseFloat(t.amount);
                    });
                 // Destroy existing chart instance if it exists
                if (window.salesChartInstance) {
                    window.salesChartInstance.destroy();
                }
                window.salesChartInstance = new Chart(salesCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Vendas por Mês (R$)',
                            data: salesData,
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
             }

            // Gráfico financeiro
            const financialCtx = document.getElementById('financialChart')?.getContext('2d');
            if(financialCtx) {
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dec'];
                const incomeData = new Array(12).fill(0);
                const expenseData = new Array(12).fill(0);
                transactions.forEach(t => {
                    const month = new Date(t.date).getMonth();
                    if (t.type === 'income') {
                        incomeData[month] += parseFloat(t.amount);
                    } else {
                        expenseData[month] += parseFloat(t.amount);
                    }
                });
                // Destroy existing chart instance if it exists
                if (window.financialChartInstance) {
                    window.financialChartInstance.destroy();
                }
                window.financialChartInstance = new Chart(financialCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: incomeData,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Despesas',
                                data: expenseData,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                fill: true
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'Novo':
                case 'Disponível':
                case 'Agendado':
                    return 'badge-primary';
                case 'Contatado':
                case 'Reservado':
                case 'Confirmado':
                    return 'badge-info';
                case 'Interessado':
                case 'Realizado':
                    return 'badge-success';
                case 'Proposta Enviada':
                case 'Negociação':
                    return 'badge-warning';
                case 'Fechado':
                case 'Vendido':
                case 'Alugado':
                    return 'badge-success';
                case 'Perdido':
                case 'Cancelado':
                    return 'badge-danger';
                default:
                    return 'badge-secondary';
            }
        }

        // =============================================
        // FUNÇÕES DE NAVEGAÇÃO E AUTENTICAÇÃO
        // =============================================

        // Modificada para incluir o carregamento de notas
        function showPage(page) {
            // Esconde todas as páginas
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            // Mostra a página solicitada
            const pageElement = document.getElementById(`${page}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
                 // Atualiza a UI específica da página
                if (page === 'financial') {
                    updateFinancial();
                } else if (page === 'reports') {
                    updateCharts();
                } else if (page === 'leads') { // Update leads page UI
                     setupLeadStatusFilter();
                     // Ensure filter is set up
                     updateAllLeadsTable(document.getElementById('lead-status-filter')?.value || '');
                } else if (page === 'properties') { // Update properties page UI
                    setupPropertyFilters();
                    // Ensure filters are set up
                    filterProperties(); // Apply filters on load
                } else if (page === 'appointments') { // Ensure appointment UI is updated
                     updateAppointmentsTable();
                } else if (page === 'tables') { // Load data for tables page
                     loadPropertiesForImport();
                     updateImportHistory();
                } else if (page === 'notes') { // Load notes for notes page
                     loadNotes();
                }
                 initModules();
                 // Re-initialize modules for the active page
            } else {
                console.error(`Page element with ID "${page}-page" not found.`);
            }
        }

        function showPasswordModal() {
            document.getElementById('password-modal').style.display = 'flex';
        }

        function hidePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
        }

        function showModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.style.display = 'flex';
            } else {
                console.error(`Modal element with ID "${modalId}" not found.`);
            }
        }

        function hideModal(modalId) {
             const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.style.display = 'none';
            } else {
                 console.error(`Modal element with ID "${modalId}" not found.`);
            }
        }

        function showConfirmationDialog(title, message, callback) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;

            const dialog = document.getElementById('confirmation-dialog');
            dialog.style.display = 'flex';
            document.getElementById('confirm-action').onclick = function() {
                callback();
                dialog.style.display = 'none';
            };

            document.getElementById('cancel-confirmation').onclick = function() {
                dialog.style.display = 'none';
            };
        }

        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                hidePasswordModal();
                updateUI();
            } else {
                alert('Email ou senha incorretos');
            }
        }

        function logout() {
            showConfirmationDialog(
                'Sair do Sistema',
                'Tem certeza que deseja sair do CRM?',
                function() {
                    currentUser = null;
                    showPasswordModal();
                }
            );
        }

        // =============================================
        // FUNÇÕES DE CLIENTE (LEAD)
        // =============================================

        function newLead() {
            document.getElementById('lead-form').reset();
            document.getElementById('lead-id').value = '';
            document.getElementById('lead-documents-preview').innerHTML = ''; // Clear document preview
            leadDocuments = [];
            // Clear document array
            document.getElementById('lead-modal-title').textContent = 'Novo Cliente';
            showModal('lead-modal');
        }

        function editLead(id) {
            const lead = leads.find(l => l.id === id);
            if (lead) {
                document.getElementById('lead-id').value = lead.id;
                document.getElementById('lead-name').value = lead.name;
                document.getElementById('lead-email').value = lead.email || '';
                document.getElementById('lead-phone').value = lead.phone;
                document.getElementById('lead-source').value = lead.source || 'Site';
                document.getElementById('lead-interest').value = lead.interest || 'Comprar';
                document.getElementById('lead-status').value = lead.status || 'Novo';
                document.getElementById('lead-notes').value = lead.notes || '';
                // Clear and add existing documents to preview
                const preview = document.getElementById('lead-documents-preview');
                preview.innerHTML = '';
                leadDocuments = lead.documents ? [...lead.documents] : [];
                // Copy existing documents

                if (leadDocuments.length > 0) {
                    leadDocuments.forEach((doc, index) => {
                        const docElement = document.createElement('div');
                        docElement.className = 'document-item';
                        docElement.innerHTML = `
                             <i class="fas fa-file-alt"></i>
                             <button class="remove-document" onclick="removeLeadDocument(${index})">
                                <i class="fas fa-times"></i>
                             </button>
                        `;
                        // Optional: Add file name as a title attribute or tooltip
                        docElement.title = doc.name;
                        preview.appendChild(docElement);
                    });
                }


                document.getElementById('lead-modal-title').textContent = 'Editar Cliente';
                showModal('lead-modal');
            }
        }

        function viewLead(id) {
            const lead = leads.find(l => l.id === id);
            if (lead) {
                document.getElementById('view-lead-name').textContent = lead.name;
                document.getElementById('view-lead-phone').textContent = lead.phone || '-';
                document.getElementById('view-lead-email').textContent = lead.email || '-';
                document.getElementById('view-lead-source').textContent = lead.source || '-';
                document.getElementById('view-lead-interest').textContent = lead.interest || '-';
                document.getElementById('view-lead-status').textContent = lead.status || '-';
                document.getElementById('view-lead-last-contact').textContent = formatDate(lead.lastContact) || '-';
                document.getElementById('view-lead-notes').textContent = lead.notes || 'Nenhuma observação.';
                // Display documents
                 const documentPreview = document.getElementById('view-lead-documents');
                 documentPreview.innerHTML = '';
                 if (lead.documents && lead.documents.length > 0) {
                     lead.documents.forEach(doc => {
                         const docElement = document.createElement('div');
                         docElement.className = 'document-item'; // Use the same styling as upload preview
                         docElement.innerHTML = `<a href="${doc.dataUrl}" target="_blank" title="${doc.name}"><i class="fas fa-file-alt"></i><span>${doc.name}</span></a>`; // Link to data URL and display name
                         documentPreview.appendChild(docElement);
                     });
                } else {
                     documentPreview.innerHTML = '<p>Nenhum documento anexado.</p>';
                }


                showModal('view-lead-modal');
            }
        }


        function saveLead() {
            const id = document.getElementById('lead-id').value;
            const name = document.getElementById('lead-name').value;
            const email = document.getElementById('lead-email').value;
            const phone = document.getElementById('lead-phone').value;
            const source = document.getElementById('lead-source').value;
            const interest = document.getElementById('lead-interest').value;
            const status = document.getElementById('lead-status').value;
            const notes = document.getElementById('lead-notes').value;

            if (!name || !phone) {
                alert('Nome e telefone são obrigatórios');
                return;
            }

            const leadData = {
                id: id ? parseInt(id) : leads.length > 0 ? Math.max(...leads.map(l => l.id)) + 1 : 1,
                name,
                email,
                phone,
                source,
                interest,
                status,
                notes,
                documents: [...leadDocuments], // Save documents
                lastContact: new Date().toISOString().split('T')[0],
                createdAt: id ? leads.find(l => l.id === parseInt(id)).createdAt : new Date().toISOString()
            };
            saveAndRefreshLead(id, leadData); // Use helper function to handle saving and refreshing

        }

        function saveAndRefreshLead(id, leadData) {
             if (id) {
                // Atualiza lead existente
                const index = leads.findIndex(l => l.id === parseInt(id));
                if(index !== -1) { // Check if lead exists
                   leads[index] = leadData;
                } else {
                   // This case should ideally not happen if editLead is called correctly
                   console.error("Lead with ID not found for update:", id);
                   return;
                }
            } else {
                // Adiciona novo lead
                leads.push(leadData);
            }

            saveData();
            updateUI();
            hideModal('lead-modal');
        }


        function deleteLead(id) {
            showConfirmationDialog(
                'Excluir Cliente',
                'Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.',
                function() {
                    leads = leads.filter(l => l.id !== id);
                    saveData();
                    updateUI();
                }
            );
        }

        function moveLeadToNextStage(id) {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;

            const stages = ['Novo', 'Contatado', 'Interessado', 'Proposta Enviada', 'Negociação', 'Fechado'];
            const currentIndex = stages.indexOf(lead.status);
            if (currentIndex < stages.length - 1) {
                lead.status = stages[currentIndex + 1];
                lead.lastContact = new Date().toISOString().split('T')[0];
                saveData();
                updateUI();
            }
        }

        function handleLeadDocumentUpload(files) {
            const preview = document.getElementById('lead-documents-preview');
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                     const docElement = document.createElement('div');
                     docElement.className = 'document-item'; // Use .document-item class
                     docElement.innerHTML = `
                         <i class="fas fa-file-alt"></i>
                         <button class="remove-document" onclick="removeLeadDocument(${leadDocuments.length})">
                             <i class="fas fa-times"></i>
                         </button>
                     `;
                     docElement.title = file.name; // Add file name on hover
                     preview.appendChild(docElement);
                     leadDocuments.push({
                         name: file.name,
                         type: file.type,
                         dataUrl: e.target.result // Store as data URL
                     });
                };

                reader.readAsDataURL(file); // Read file as Data URL
            }
        }

        function removeLeadDocument(index) {
            leadDocuments.splice(index, 1);
            // Rebuild the preview
            const preview = document.getElementById('lead-documents-preview');
            preview.innerHTML = '';

            leadDocuments.forEach((doc, i) => {
                 const docElement = document.createElement('div');
                 docElement.className = 'document-item'; // Use .document-item class
                 docElement.innerHTML = `
                     <i class="fas fa-file-alt"></i>
                     <button class="remove-document" onclick="removeLeadDocument(${i})">
                         <i class="fas fa-times"></i>
                     </button>
                 `;
                 docElement.title = doc.name; // Add file name on hover
                 preview.appendChild(docElement);
            });
        }


        // =============================================
        // FUNÇÕES DE IMÓVEL
        // =============================================

        function newProperty() {
            document.getElementById('property-form').reset();
            document.getElementById('property-id').value = '';
            document.getElementById('property-images-preview').innerHTML = '';
            propertyImages = [];
            document.getElementById('property-modal-title').textContent = 'Novo Imóvel';
            showModal('property-modal');
        }

        function editProperty(id) {
            const property = properties.find(p => p.id === id);
            if (property) {
                document.getElementById('property-id').value = property.id;
                document.getElementById('property-name').value = property.name || ''; // Load property name
                document.getElementById('property-code').value = property.code;
                document.getElementById('property-type').value = property.type || 'Casa';
                document.getElementById('property-address').value = property.address;
                document.getElementById('property-neighborhood').value = property.neighborhood || '';
                document.getElementById('property-city').value = property.city || '';
                document.getElementById('property-state').value = property.state || '';
                document.getElementById('property-price').value = property.price || '';
                document.getElementById('property-area').value = property.area || '';
                document.getElementById('property-bedrooms').value = property.bedrooms || '';
                document.getElementById('property-bathrooms').value = property.bathrooms || '';
                document.getElementById('property-parking').value = property.parking || '';
                document.getElementById('property-stock').value = property.stock || 0; // Load property stock
                document.getElementById('property-status').value = property.status || 'Disponível';
                document.getElementById('property-description').value = property.description || '';
                // Limpa preview de imagens
                const preview = document.getElementById('property-images-preview');
                preview.innerHTML = '';
                propertyImages = [];

                // Adiciona imagens existentes
                if (property.images && property.images.length > 0) {
                    property.images.forEach((img, index) => {
                        const imgElement = document.createElement('div');
                        imgElement.className = 'image-preview';
                        imgElement.innerHTML = `
                            <img src="${img}" alt="Imagem do imóvel">
                            <button class="remove-image" onclick="removePropertyImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        preview.appendChild(imgElement);
                        propertyImages.push(img);
                    });
                }

                document.getElementById('property-modal-title').textContent = 'Editar Imóvel';
                showModal('property-modal');
            }
        }

        function viewProperty(id) {
             const property = properties.find(p => p.id === id);
            if (property) {
                // Adicionar o data-property-id ao card
                document.querySelector('#view-property-modal .property-detail-card').dataset.propertyId = property.id;

                document.getElementById('view-property-name').textContent = property.name || 'Imóvel sem nome'; // Display Property Name
                document.getElementById('view-property-address').textContent = property.address || 'Imóvel sem endereço'; // Display Address
                document.getElementById('view-property-code').textContent = property.code || '-';
                document.getElementById('view-property-type').textContent = property.type || '-';
                document.getElementById('view-property-price').textContent = formatCurrency(property.price) || '-';
                document.getElementById('view-property-status').textContent = property.status || '-';
                document.getElementById('view-property-stock').textContent = property.stock || '0'; // Display property stock

                 document.getElementById('view-property-neighborhood').textContent = property.neighborhood || '-';
                 document.getElementById('view-property-city').textContent = property.city || '-';
                 document.getElementById('view-property-state').textContent = property.state || '-';

                document.getElementById('view-property-area').textContent = property.area ? `${property.area} m²` : '-';
                document.getElementById('view-property-bedrooms').textContent = property.bedrooms || '-';
                document.getElementById('view-property-bathrooms').textContent = property.bathrooms || '-';
                document.getElementById('view-property-parking').textContent = property.parking || '-';

                document.getElementById('view-property-description').textContent = property.description || 'Nenhuma descrição disponível.';

                // Display images and add click listeners for image viewer
                const imageGallery = document.getElementById('view-property-images-preview');
                imageGallery.innerHTML = '';
                currentImageViewerImages = property.images || []; // Store images for the viewer

                if (currentImageViewerImages.length > 0) {
                     currentImageViewerImages.forEach((imgSrc, index) => {
                        const imgElementWrapper = document.createElement('div');
                        imgElementWrapper.className = 'image-preview'; // Reuse image-preview class for styling
                        const imgElement = document.createElement('img');
                        imgElement.src = imgSrc;
                        imgElement.alt = `Imagem ${index + 1} do imóvel`;

                        // Add click listener to open full-screen viewer
                        imgElement.addEventListener('click', () => {
                            showImageViewer(index);
                        });

                        imgElementWrapper.appendChild(imgElement);
                        imageGallery.appendChild(imgElementWrapper);
                    });
                } else {
                    imageGallery.innerHTML = '<p>Nenhuma imagem disponível.</p>';
                }

                showModal('view-property-modal');
            }
        }


        function saveProperty() {
            const id = document.getElementById('property-id').value;
            const name = document.getElementById('property-name').value; // Get property name
            const code = document.getElementById('property-code').value;
            const type = document.getElementById('property-type').value;
            const address = document.getElementById('property-address').value;
            const neighborhood = document.getElementById('property-neighborhood').value;
            const city = document.getElementById('property-city').value;
            const state = document.getElementById('property-state').value;
            const price = document.getElementById('property-price').value;
            const area = document.getElementById('property-area').value;
            const bedrooms = document.getElementById('property-bedrooms').value;
            const bathrooms = document.getElementById('property-bathrooms').value;
            const parking = document.getElementById('property-parking').value;
            const stock = document.getElementById('property-stock').value; // Get property stock
            const status = document.getElementById('property-status').value;
            const description = document.getElementById('property-description').value;

            if (!name || !code || !address || !price) { // Name is now required
                alert('Nome, código, endereço e preço são obrigatórios');
                return;
            }

            const propertyData = {
                id: id ? parseInt(id) : properties.length > 0 ? Math.max(...properties.map(p => p.id)) + 1 : 1,
                name, // Save property name
                code,
                type,
                address,
                neighborhood,
                city,
                state,
                price: parseFloat(price),
                area: area ? parseFloat(area) : null,
                bedrooms: bedrooms ? parseInt(bedrooms) : null,
                bathrooms: bathrooms ? parseInt(bathrooms) : null,
                parking: parking ? parseInt(parking) : null,
                stock: stock ? parseInt(stock) : 0, // Save property stock
                status,
                description,
                images: [...propertyImages],
                createdAt: id ? properties.find(p => p.id === parseInt(id)).createdAt : new Date().toISOString()
            };
            if (id) {
                // Atualiza imóvel existente
                const index = properties.findIndex(p => p.id === parseInt(id));
                if(index !== -1) { // Check if property exists
                   properties[index] = propertyData;
                } else {
                   console.error("Property with ID not found for update:", id);
                   return;
                }
            } else {
                // Adiciona novo imóvel
                properties.push(propertyData);
            }

            saveData();
            updateUI();
            hideModal('property-modal');
        }

        function deleteProperty(id) {
            showConfirmationDialog(
                'Excluir Imóvel',
                'Tem certeza que deseja excluir este imóvel? Esta ação não pode ser desfeita.',
                function() {
                    properties = properties.filter(p => p.id !== id);
                    saveData();
                    updateUI();
                }
            );
        }

        function handleImageUpload(files) {
            const preview = document.getElementById('property-images-preview');
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const imgElement = document.createElement('div');
                    imgElement.className = 'image-preview';
                    imgElement.innerHTML = `
                        <img src="${e.target.result}" alt="Preview da imagem">
                        <button class="remove-image" onclick="removePropertyImage(${propertyImages.length})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(imgElement);
                    propertyImages.push(e.target.result);
                };

                reader.readAsDataURL(file);
            }
        }

        function removePropertyImage(index) {
            propertyImages.splice(index, 1);
            // Reconstroi o preview
            const preview = document.getElementById('property-images-preview');
            preview.innerHTML = '';

            propertyImages.forEach((img, i) => {
                const imgElement = document.createElement('div');
                imgElement.className = 'image-preview';
                imgElement.innerHTML = `
                    <img src="${img}" alt="Preview da imagem">
                    <button class="remove-image" onclick="removePropertyImage(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(imgElement);
            });
        }

        // Função para baixar a ficha do imóvel em PDF
        function downloadPropertyPdf(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) {
                alert('Imóvel não encontrado para gerar PDF.');
                return;
            }

            const doc = new jsPDF();
            let yPosition = 20;

            doc.setFontSize(18);
            doc.text(`Ficha do Imóvel - ${property.name || property.address}`, 105, yPosition, { align: 'center' });
            yPosition += 10;

            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 105, yPosition, { align: 'center' });
            yPosition += 20;

            // Adicionar detalhes do imóvel
            doc.text('Detalhes do Imóvel:', 14, yPosition);
            yPosition += 10;

            doc.text(`Código: ${property.code || '-'}`, 14, yPosition);
            doc.text(`Tipo: ${property.type || '-'}`, 100, yPosition);
            yPosition += 10;

            doc.text(`Endereço: ${property.address || '-'}`, 14, yPosition);
            yPosition += 10;

            doc.text(`Bairro: ${property.neighborhood || '-'}`, 14, yPosition);
            doc.text(`Cidade: ${property.city || '-'}`, 100, yPosition);
             yPosition += 10;
            doc.text(`Estado: ${property.state || '-'}`, 14, yPosition);
             yPosition += 10;


            doc.text(`Preço: ${formatCurrency(property.price) || '-'}`, 14, yPosition);
            doc.text(`Status: ${property.status || '-'}`, 100, yPosition);
             yPosition += 10;
            doc.text(`Estoque: ${property.stock || '0'}`, 14, yPosition);
             yPosition += 10;


            doc.text(`Área (m²): ${property.area || '-'}`, 14, yPosition);
            doc.text(`Quartos: ${property.bedrooms || '-'}`, 100, yPosition);
             yPosition += 10;
            doc.text(`Banheiros: ${property.bathrooms || '-'}`, 14, yPosition);
            doc.text(`Vagas: ${property.parking || '-'}`, 100, yPosition);
             yPosition += 20;


            doc.text('Descrição:', 14, yPosition);
            yPosition += 10;
            // Adicionar a descrição com quebras de linha
            const descriptionLines = doc.splitTextToSize(property.description || 'Nenhuma descrição disponível.', 180); // Quebrar texto para caber na página
            doc.text(descriptionLines, 14, yPosition);
            yPosition += (descriptionLines.length * 10) + 10; // Ajustar posição y

            // Adicionar imagens (simplificado: apenas lista URLs, gerar imagens requer mais complexidade)
            if (property.images && property.images.length > 0) {
                 doc.text('Imagens (URLs):', 14, yPosition);
                 yPosition += 10;
                 property.images.forEach(imageUrl => {
                     if (yPosition > 280) { // Verificar se precisa de nova página antes de adicionar URL
                         doc.addPage();
                         yPosition = 20;
                         doc.text('Imagens (URLs): (continuação)', 14, yPosition);
                         yPosition += 10;
                     }
                     doc.text(`- ${imageUrl}`, 14, yPosition);
                     yPosition += 7; // Espaço menor entre URLs
                 });
            } else {
                 doc.text('Nenhuma imagem disponível.', 14, yPosition);
                  yPosition += 10;
            }


            // Salva o PDF
            doc.save(`ficha_imovel_${property.code}.pdf`);
        }


        // =============================================
        // FUNÇÕES DE AGENDAMENTO
        // =============================================

        function newAppointment() {
            document.getElementById('appointment-form').reset();
            document.getElementById('appointment-id').value = '';

            // Preenche dropdown de leads
            const leadSelect = document.getElementById('appointment-lead');
            leadSelect.innerHTML = '<option value="">Selecione um cliente</option>';
            leads.forEach(lead => {
                const option = document.createElement('option');
                option.value = lead.id;
                option.textContent = lead.name;
                leadSelect.appendChild(option);
            });
            // Preenche dropdown de imóveis
            const propertySelect = document.getElementById('appointment-property');
            propertySelect.innerHTML = '<option value="">Selecione um imóvel</option>';
            properties.forEach(property => {
                const option = document.createElement('option');
                option.value = property.id;
                option.textContent = `${property.code} - ${property.name || property.address}`; // Display name or address
                propertySelect.appendChild(option);
            });
            document.getElementById('appointment-date').value = new Date().toISOString().split('T')[0]; // Default to today
            document.getElementById('appointment-time').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
            // Default to current time
            document.getElementById('appointment-type').value = 'Visita';
            // Default type
            document.getElementById('appointment-status').value = 'Agendado';
            // Default status

            document.getElementById('appointment-modal-title').textContent = 'Novo Agendamento';
            showModal('appointment-modal');
             setupAppointmentTypeListener();
             // Ensure listener is active
        }

        function editAppointment(id) {
            const appointment = appointments.find(a => a.id === id);
            if (appointment) {
                document.getElementById('appointment-id').value = appointment.id;
                // Preenche dropdown de leads
                const leadSelect = document.getElementById('appointment-lead');
                leadSelect.innerHTML = '<option value="">Selecione um cliente</option>';
                leads.forEach(lead => {
                    const option = document.createElement('option');
                    option.value = lead.id;
                    option.textContent = lead.name;
                    option.selected = lead.id === appointment.leadId;
                    leadSelect.appendChild(option);
                });
                // Preenche dropdown de imóveis
                const propertySelect = document.getElementById('appointment-property');
                propertySelect.innerHTML = '<option value="">Selecione um imóvel</option>';
                properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = `${property.code} - ${property.name || property.address}`; // Display name or address
                    option.selected = property.id === appointment.propertyId;
                    propertySelect.appendChild(option);
                });
                document.getElementById('appointment-date').value = appointment.date;
                document.getElementById('appointment-time').value = appointment.time || '12:00';
                document.getElementById('appointment-type').value = appointment.type || 'Visita';
                document.getElementById('appointment-status').value = appointment.status || 'Agendado';
                document.getElementById('appointment-notes').value = appointment.notes || '';

                document.getElementById('appointment-modal-title').textContent = 'Editar Agendamento';
                showModal('appointment-modal');
                setupAppointmentTypeListener();
                // Ensure listener is active
            }
        }

        function saveAppointment() {
            const id = document.getElementById('appointment-id').value;
            const leadId = parseInt(document.getElementById('appointment-lead').value);
            const propertyId = parseInt(document.getElementById('appointment-property').value);
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;
            const type = document.getElementById('appointment-type').value;
            const status = document.getElementById('appointment-status').value;
            const notes = document.getElementById('appointment-notes').value;

            // Validation logic updated
            if (type !== 'Plantão' && (!leadId || !propertyId)) {
                 alert('Para tipos diferentes de Plantão, Cliente e Imóvel são obrigatórios.');
                return;
            }

            if (!date) { // Date is always required
                alert('Data é obrigatória');
                return;
            }


            const appointmentData = {
                id: id ? parseInt(id) : appointments.length > 0 ? Math.max(...appointments.map(a => a.id)) + 1 : 1,
                leadId: type === 'Plantão' ? null : leadId, // Save null if Plantão
                propertyId: type === 'Plantão' ? null : propertyId, // Save null if Plantão
                date,
                time,
                type,
                status,
                notes,
                createdAt: id ? appointments.find(a => a.id === parseInt(id)).createdAt : new Date().toISOString()
            };
            if (id) {
                // Atualiza agendamento existente
                const index = appointments.findIndex(a => a.id === parseInt(id));
                if(index !== -1) { // Check if appointment exists
                   appointments[index] = appointmentData;
                } else {
                   console.error("Appointment with ID not found for update:", id);
                   return;
                }
            } else {
                // Adiciona novo agendamento
                appointments.push(appointmentData);
            }

            saveData();
            updateUI();
            hideModal('appointment-modal');
        }

        function deleteAppointment(id) {
            showConfirmationDialog(
                'Excluir Agendamento',
                'Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita.',
                function() {
                    appointments = appointments.filter(a => a.id !== id);
                    saveData();
                    updateUI();
                }
            );
        }

        // Nova função para marcar agendamento como concluído
        function markAppointmentAsCompleted(id) {
            showConfirmationDialog(
                'Marcar como Concluído',
                'Tem certeza que deseja marcar este agendamento como Realizado?',
                function() {
                    const appointment = appointments.find(a => a.id === id);
                    if (appointment) {
                        appointment.status = 'Realizado';
                        saveData(); // Salva a mudança
                        updateUI(); // Atualiza a interface
                        hideModal('view-appointment-modal'); // Fecha o modal
                    } else {
                        alert('Agendamento não encontrado.');
                    }
                }
            );
        }

         // Function to show appointment alerts
        function showAppointmentAlerts() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
            const relevantAppointments = appointments.filter(appointment => {
                // Exclui agendamentos com status 'Realizado' ou 'Cancelado' do alerta
                if (appointment.status === 'Realizado' || appointment.status === 'Cancelado') {
                    return false;
                }

                const appointmentDateTime = new Date(`${appointment.date}T${appointment.time}`);
                // Inclui agendamentos que são hoje e ainda não passaram do horário
                // Ou agendamentos com data no passado (que são considerados pendentes até serem marcados como Realizado/Cancelado)
                // Note: O filtro acima já excluiu os Realizados/Cancelados, então aqui só lidamos com os "ativos"
                 return appointmentDateTime.toISOString().split('T')[0] === today || appointmentDateTime < now;
            });
            const alertBody = document.getElementById('appointment-alert-body');
            alertBody.innerHTML = ''; // Clear previous alerts

            // Atualiza o card de agendamentos para piscar se houver alertas
            const appointmentCard = document.querySelector('.stat-card:nth-child(3)');
            if (relevantAppointments.length > 0) {
                appointmentCard.classList.add('blink');
                relevantAppointments.forEach(app => {
                    const lead = leads.find(l => l.id === app.leadId) || { name: 'Não informado' };
                    const property = properties.find(p => p.id === app.propertyId) || { code: 'Não informado' };

                    const alertItem = document.createElement('div');
                    alertItem.className = 'appointment-alert-item';
                    alertItem.innerHTML = `
                        <div class="appointment-alert-details">
                            <strong>${app.type || 'Agendamento'}</strong> em ${formatDateTime(app.date, app.time)}
                            <br>
                            Cliente: ${app.type === 'Plantão' ? '-' : lead.name} | Imóvel: ${app.type === 'Plantão' ? '-' : property.code}
                        </div>
                       <div class="appointment-alert-actions">
                            <button class="btn btn-info btn-sm" onclick="viewAppointment(${app.id}); hideAppointmentAlert();">
                                <i class="fas fa-eye"></i> Visualizar
                            </button>
                        </div>
                    `;
                    alertBody.appendChild(alertItem);
                });

                showModal('appointment-alert'); // Show the custom alert modal
            } else {
                appointmentCard.classList.remove('blink');
            }
        }

        function hideAppointmentAlert() {
            hideModal('appointment-alert');
        }


        // =============================================
        // FUNÇÕES FINANCEIRAS
        // =============================================

        function updateFinancial() {
            const filter = document.getElementById('financial-filter').value;
            updateTransactionsTable(filter);
        }

        function newTransaction() {
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-modal-title').textContent = 'Nova Transação';
            showModal('transaction-modal');
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                document.getElementById('transaction-id').value = transaction.id;
                document.getElementById('transaction-type').value = transaction.type;
                document.getElementById('transaction-category').value = transaction.category;
                document.getElementById('transaction-description').value = transaction.description;
                document.getElementById('transaction-amount').value = transaction.amount;
                document.getElementById('transaction-date').value = transaction.date;
                document.getElementById('transaction-payment').value = transaction.payment || 'Dinheiro';
                document.getElementById('transaction-notes').value = transaction.notes || '';

                document.getElementById('transaction-modal-title').textContent = 'Editar Transação';
                showModal('transaction-modal');
            }
        }

        function saveTransaction() {
            const id = document.getElementById('transaction-id').value;
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const description = document.getElementById('transaction-description').value;
            const amount = document.getElementById('transaction-amount').value;
            const date = document.getElementById('transaction-date').value;
            const payment = document.getElementById('transaction-payment').value;
            const notes = document.getElementById('transaction-notes').value;

            if (!description || !amount || !date) {
                alert('Descrição, valor e data são obrigatórios');
                return;
            }

            const transactionData = {
                id: id ? parseInt(id) : transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                type,
                category,
                description,
                amount: parseFloat(amount),
                date,
                payment,
                notes,
                createdAt: id ? transactions.find(t => t.id === parseInt(id)).createdAt : new Date().toISOString()
            };
            if (id) {
                // Atualiza transação existente
                const index = transactions.findIndex(t => t.id === parseInt(id));
                if(index !== -1) { // Check if transaction exists
                   transactions[index] = transactionData;
                } else {
                   console.error("Transaction with ID not found for update:", id);
                   return;
                }
            } else {
                // Adiciona nova transação
                transactions.push(transactionData);
            }

            saveData();
            updateUI();
            hideModal('transaction-modal');
        }

        function deleteTransaction(id) {
            showConfirmationDialog(
                'Excluir Transação',
                'Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.',
                function() {
                    transactions = transactions.filter(t => t.id !== id);
                    saveData();
                    updateUI();
                }
            );
        }

        function newReceipt() {
            // Preenche os dados do recibo com valores padrão
            document.getElementById('receipt-number').textContent = (transactions.filter(t => t.type === 'income').length + 1).toString().padStart(4, '0');
            document.getElementById('receipt-date').textContent = new Date().toLocaleDateString('pt-BR');
            document.getElementById('receipt-from').textContent = 'Cliente';
            document.getElementById('receipt-document').textContent = '000.000.000-00';
            document.getElementById('receipt-reference').textContent = 'Serviços prestados';
            document.getElementById('receipt-amount').textContent = 'R$ 0,00';
            document.getElementById('receipt-payment').textContent = 'Dinheiro';

            // Atualiza nome da empresa se existir nas configurações
            if (settings.companyName) {
                document.getElementById('receipt-company-name').textContent = settings.companyName;
            }

            showModal('receipt-modal');
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            const doc = new jsPDF();
            // Adiciona conteúdo ao PDF
            doc.setFontSize(18);
            doc.text(`Recibo - ${document.getElementById('receipt-company-name').textContent}`, 105, 20, { align: 'center' }); // Add "Recibo -" prefix

            doc.setFontSize(12);
            let yPosition = 40;
             doc.text(`Recibo Nº: ${document.getElementById('receipt-number').textContent}`, 20, yPosition);
             yPosition += 10;
            doc.text(`Data: ${document.getElementById('receipt-date').textContent}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Recebemos de: ${document.getElementById('receipt-from').textContent}`, 20, yPosition);
            yPosition += 10;
            doc.text(`CPF/CNPJ: ${document.getElementById('receipt-document').textContent}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Referente a: ${document.getElementById('receipt-reference').textContent}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Valor: ${document.getElementById('receipt-amount').textContent}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Forma de Pagamento: ${document.getElementById('receipt-payment').textContent}`, 20, yPosition);
            yPosition += 20;
            doc.text('___________________________', 105, yPosition, { align: 'center' });
            yPosition += 10;
            doc.text('Assinatura', 105, yPosition, { align: 'center' });
            // Salva o PDF
            doc.save(`recibo_${document.getElementById('receipt-number').textContent}.pdf`);
        }

        // =============================================
        // FUNÇÕES DE USUÁRIO
        // =============================================

        function newUser() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-modal-title').textContent = 'Novo Usuário';
            showModal('user-modal');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-name').value = user.name;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-role').value = user.role;

                document.getElementById('user-modal-title').textContent = 'Editar Usuário';
                showModal('user-modal');
            }
        }

        function saveUser() {
            const id = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const confirmPassword = document.getElementById('user-confirm-password').value;
            const role = document.getElementById('user-role').value;
            if (!name || !email || !role) {
                alert('Nome, email e perfil são obrigatórios');
                return;
            }

            if ((!id || password) && password !== confirmPassword) {
                alert('As senhas não coincidem');
                return;
            }

            const userData = {
                id: id ? parseInt(id) : users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                name,
                email,
                role,
                password: id && !password ? users.find(u => u.id === parseInt(id)).password : password
            };
            if (id) {
                // Atualiza usuário existente
                const index = users.findIndex(u => u.id === parseInt(id));
                if(index !== -1) { // Check if user exists
                   users[index] = userData;
                } else {
                   console.error("User with ID not found for update:", id);
                   return;
                }
            } else {
                // Adiciona novo usuário
                users.push(userData);
            }

            saveData();
            updateUI();
            hideModal('user-modal');
        }

        function deleteUser(id) {
            if (users.length <= 1) {
                alert('Não é possível excluir o último usuário');
                return;
            }

            showConfirmationDialog(
                'Excluir Usuário',
                'Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.',
                function() {
                    users = users.filter(u => u.id !== id);
                    saveData();
                    updateUI();
                }
            );
        }

        function checkPassword() {
            const password = document.getElementById('crm-password').value;
            if (password === settings.crmPassword) {
                document.getElementById('password-modal').style.display = 'none';
            } else {
                alert('Senha incorreta');
            }
        }

        // =============================================
        // FUNÇÕES DE IMPORTAÇÃO DE TABELAS
        // =============================================

        // Função para carregar os imóveis no dropdown
        function loadPropertiesForImport() {
            const select = document.getElementById('import-property');
            if (!select) return; // Safety check
            select.innerHTML = '<option value="">Selecione um imóvel</option>';

            properties.forEach(property => {
                const option = document.createElement('option');
                option.value = property.id;
                option.textContent = `${property.code} - ${property.name || property.address}`;
                select.appendChild(option);
            });
        }

        // Função para processar o arquivo importado
        function importTableFile() {
            const fileInput = document.getElementById('import-file');
            const propertyId = parseInt(document.getElementById('import-property').value);

            if (!fileInput?.files?.length || !propertyId) { // Added safety checks
                alert('Selecione um arquivo e um imóvel para importar');
                return;
            }

            const property = properties.find(p => p.id === propertyId);
            if (!property) {
                alert('Imóvel não encontrado');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    // Processar o arquivo CSV ou Excel
                    const content = e.target.result;
                    let items = [];

                    if (file.name.endsWith('.csv')) {
                        items = processCSV(content);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        items = processExcel(content);
                    }

                    if (items.length > 0) {
                        // Zerar estoque e somar quantidade na coluna situação
                        const sumQuantity = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                        property.stock = sumQuantity;

                        // Registrar a importação no histórico
                        const importRecord = {
                            date: new Date().toISOString(),
                            propertyId: property.id,
                            propertyName: property.name || property.address,
                            itemsCount: sumQuantity,
                            fileName: file.name
                        };

                        importHistory.unshift(importRecord);
                        localStorage.setItem('importHistory', JSON.stringify(importHistory));

                        saveData();
                        updateUI();
                        updateImportHistory();

                        alert(`Sucesso! ${items.length} itens importados para ${property.name || property.address}. Estoque atual: ${property.stock}`);
                    } else {
                        alert('Nenhum item válido encontrado no arquivo');
                    }
                } catch (error) {
                    console.error('Erro ao importar arquivo:', error);
                    alert('Erro ao processar o arquivo. Verifique o formato e tente novamente.');
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Funções auxiliares para processar arquivos
        function processCSV(content) {
            const lines = content.split('\n');
            const items = [];

            // Pular o cabeçalho se existir
            const startLine = lines.length > 0 && (lines[0].includes(';') || lines[0].includes(',')) ? 1 : 0;


            for (let i = startLine; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                // Processar linha (simplificado - adaptar conforme necessidade)
                const values = lines[i].split(/[;,]/).map(v => v.trim());
                if (values.length > 0 && values[0] !== '') {
                    items.push({
                        code: values[0] || '',
                        description: values[1] || '',
                        quantity: parseInt(values[2]) || 1
                    });
                }
            }

            return items;
        }

        function processExcel(content) {
            // Implementação simplificada - na prática, use uma biblioteca como xlsx
            alert('Importação de Excel requer biblioteca adicional. Use CSV para teste.');
            return [];
            // Na implementação real:
            // const workbook = XLSX.read(content, {type: 'array'});
            // const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            // return XLSX.utils.sheet_to_json(worksheet);
        }

        // Atualizar o histórico de importações
        function updateImportHistory() {
            const table = document.getElementById('import-history-table');
            if (!table) return; // Safety check
            table.innerHTML = '';

            importHistory.slice(0, 10).forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.propertyName}</td>
                    <td>${record.itemsCount}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewImportDetails('${record.fileName}')">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // Função dummy para visualizar detalhes da importação (pode ser expandida)
        function viewImportDetails(fileName) {
             alert(`Detalhes para importação do arquivo: ${fileName}\n(Implementação completa de detalhes não incluída nesta versão)`);
        }


        // =============================================
        // FUNÇÕES DE CONFIGURAÇÕES
        // =============================================

        function saveBranding() {
            const logoInput = document.getElementById('company-logo');
            const companyName = document.getElementById('company-name').value;

            if (logoInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    settings.logo = e.target.result;
                    document.getElementById('crm-logo').src = e.target.result;

                    // Atualiza preview
                    const preview = document.getElementById('logo-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Logo da empresa">`;

                    settings.companyName = companyName;
                    saveData();
                    alert('Personalização salva com sucesso!');
                };

                reader.readAsDataURL(logoInput.files[0]);
            } else {
                settings.companyName = companyName;
                saveData();
                alert('Personalização salva com sucesso!');
            }
        }

        function generatePDFReport(type) {
            const doc = new jsPDF();
            let yPosition = 20;

            doc.setFontSize(18);
            doc.text(`Relatório de ${type === 'leads' ? 'Clientes' : type === 'properties' ? 'Imóveis' : type === 'financial' ? 'Financeiro' : 'Funil de Vendas'}`, 105, 20, { align: 'center' });
            yPosition += 10;

            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 105, yPosition, { align: 'center' });
            yPosition += 20;
            switch(type) {
                case 'leads':
                    doc.text('Lista de Clientes', 14, yPosition);
                    yPosition += 10;

                    doc.text('Nome', 14, yPosition);
                    doc.text('Telefone', 60, yPosition);
                    doc.text('Status', 100, yPosition);
                    doc.text('Último Contato', 140, yPosition);
                    yPosition += 10;
                    leads.forEach(lead => {
                        if (yPosition > 280) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.text(lead.name, 14, yPosition);
                        doc.text(lead.phone, 60, yPosition);
                        doc.text(lead.status, 100, yPosition);
                        doc.text(formatDate(lead.lastContact), 140, yPosition);
                        yPosition += 10;
                    });
                    break;

                case 'properties':
                    doc.text('Lista de Imóveis', 14, yPosition);
                    yPosition += 10;

                    doc.text('Código', 14, yPosition);
                    doc.text('Nome', 40, yPosition); // Added Nome to PDF report
                    doc.text('Tipo', 80, yPosition);
                    doc.text('Endereço', 120, yPosition);
                    doc.text('Preço', 170, yPosition);
                    yPosition += 10;

                    properties.forEach(property => {
                        if (yPosition > 280) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.text(property.code, 14, yPosition);
                        doc.text(property.name || '-', 40, yPosition); // Print property name
                        doc.text(property.type, 80, yPosition);
                        doc.text(property.address, 120, yPosition);
                        doc.text(formatCurrency(property.price), 170, yPosition);
                        yPosition += 10;
                    });
                    break;
                case 'financial':
                    doc.text('Resumo Financeiro', 14, yPosition);
                    yPosition += 10;

                    doc.text('Receitas Totais:', 14, yPosition);
                    doc.text(document.getElementById('total-income').textContent, 60, yPosition);
                    yPosition += 10;

                    doc.text('Despesas Totais:', 14, yPosition);
                    doc.text(document.getElementById('total-expenses').textContent, 60, yPosition);
                    yPosition += 10;

                    doc.text('Saldo Atual:', 14, yPosition);
                    doc.text(document.getElementById('current-balance').textContent, 60, yPosition);
                    yPosition += 20;

                    doc.text('Últimas Transações', 14, yPosition);
                    yPosition += 10;
                    doc.text('Data', 14, yPosition);
                    doc.text('Descrição', 40, yPosition);
                    doc.text('Valor', 120, yPosition);
                    doc.text('Tipo', 160, yPosition);
                    yPosition += 10;
                    transactions.slice(0, 20).forEach(transaction => {
                        if (yPosition > 280) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.text(formatDate(transaction.date), 14, yPosition);
                        doc.text(transaction.description.substring(0, 30), 40, yPosition);
                        doc.text(formatCurrency(transaction.amount), 120, yPosition);
                        doc.text(transaction.type === 'income' ? 'Receita' : 'Despesa', 160, yPosition);
                        yPosition += 10;
                    });
                    break;

                case 'funnel':
                    doc.text('Funil de Vendas', 14, yPosition);
                    yPosition += 10;

                    const stages = ['Novo', 'Contatado', 'Interessado', 'Proposta Enviada', 'Negociação', 'Fechado'];
                    stages.forEach(stage => {
                        const count = leads.filter(l => l.status === stage).length;

                        doc.text(`${stage}: ${count} clientes`, 14, yPosition);
                        yPosition += 10;
                    });
                    break;
            }

            doc.save(`relatorio_${type}.pdf`);
        }

        function exportBackup() {
            exportBackupToFile();
        }

        // =============================================
        // FUNÇÕES DE NOTAS
        // =============================================

        // Carrega as notas salvas (usando localStorage para simplicidade)
        function loadNotes() {
            const savedNotes = localStorage.getItem('crm_user_notes');
            const notesTextarea = document.getElementById('notes-content');
            if (notesTextarea && savedNotes) {
                notesTextarea.value = savedNotes;
            } else if (notesTextarea) {
                 notesTextarea.value = ''; // Clear if no saved notes
            }
        }

        // Salva as notas no localStorage
        function saveNotes() {
            const notesTextarea = document.getElementById('notes-content');
            if (notesTextarea) {
                localStorage.setItem('crm_user_notes', notesTextarea.value);
                alert('Notas salvas com sucesso!');
            }
        }

        // Imprime o conteúdo das notas
        function printNotes() {
            const notesTextarea = document.getElementById('notes-content');
            if (notesTextarea) {
                const notesToPrint = notesTextarea.value;
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Minhas Notas</title>');
                printWindow.document.write('<style>');
                printWindow.document.write('body { font-family: sans-serif; line-height: 1.5; white-space: pre-wrap; }'); // pre-wrap preserves formatting
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h1>Minhas Notas</h1>');
                printWindow.document.write('<p>' + notesToPrint.replace(/\n/g, '<br>') + '</p>'); // Replace newlines for HTML
                printWindow.document.close();
                printWindow.print();
            }
        }


        // =============================================
        // FUNÇÕES DO VISUALIZADOR DE IMAGENS
        // =============================================

        function showImageViewer(startIndex) {
            currentImageViewerIndex = startIndex;
            updateImageViewer();
            showModal('image-viewer-modal');
        }

        function updateImageViewer() {
            const fullscreenImage = document.getElementById('fullscreen-image');
            const prevButton = document.getElementById('prev-image-btn');
            const nextButton = document.getElementById('next-image-btn');
            const imageCounter = document.getElementById('image-counter');

            if (currentImageViewerImages.length > 0) {
                fullscreenImage.src = currentImageViewerImages[currentImageViewerIndex];
                imageCounter.textContent = `${currentImageViewerIndex + 1} / ${currentImageViewerImages.length}`;

                // Show/hide navigation buttons
                prevButton.style.display = currentImageViewerIndex > 0 ? 'flex' : 'none';
                nextButton.style.display = currentImageViewerIndex < currentImageViewerImages.length - 1 ? 'flex' : 'none';
            } else {
                fullscreenImage.src = '';
                imageCounter.textContent = 'Nenhuma imagem';
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
            }
        }

        function navigateImageViewer(direction) {
            currentImageViewerIndex += direction;
            if (currentImageViewerIndex < 0) {
                currentImageViewerIndex = 0;
            } else if (currentImageViewerIndex >= currentImageViewerImages.length) {
                currentImageViewerIndex = currentImageViewerImages.length - 1;
            }
            updateImageViewer();
        }


        // =============================================
        // CONFIGURAÇÃO DE EVENTOS
        // =============================================

        function setupEventListeners() {
            // Navegação do menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);

                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            // Botão de logout
            document.getElementById('logout-btn').addEventListener('click', logout);
            // Botões de leads
            document.getElementById('new-lead-btn').addEventListener('click', newLead);
            document.getElementById('new-lead-btn2').addEventListener('click', newLead);
            document.getElementById('view-all-leads').addEventListener('click', function(e) {
                e.preventDefault();
                showPage('leads');
                document.querySelector('.menu-item[data-page="leads"]').click();
            });
            document.getElementById('save-lead').addEventListener('click', saveLead);
             // Lead document upload
             document.getElementById('lead-documents').addEventListener('change', function(e) {
                 handleLeadDocumentUpload(e.target.files);
             });
            // Botões de propriedades
            document.getElementById('new-property-btn').addEventListener('click', newProperty);
            document.getElementById('view-all-properties').addEventListener('click', function(e) {
                e.preventDefault();
                showPage('properties');
                document.querySelector('.menu-item[data-page="properties"]').click();
            });
            document.getElementById('save-property').addEventListener('click', saveProperty);
            document.getElementById('property-images').addEventListener('change', function(e) {
                handleImageUpload(e.target.files);
            });
            // Botão para baixar PDF da ficha do imóvel
            document.getElementById('download-property-pdf').addEventListener('click', function() {
                // Recupera o ID do imóvel que está sendo visualizado
                const propertyId = parseInt(document.querySelector('#view-property-modal .modal-body .property-detail-card').dataset.propertyId);
                if (propertyId) {
                     downloadPropertyPdf(propertyId);
                } else {
                     alert('Não foi possível identificar o imóvel para download.');
                }
            });
            // Botões de agendamentos
            document.getElementById('new-appointment-btn').addEventListener('click', newAppointment);
            document.getElementById('save-appointment').addEventListener('click', saveAppointment);
            // Botões financeiros
            document.getElementById('new-transaction-btn').addEventListener('click', newTransaction);
            document.getElementById('new-receipt-btn').addEventListener('click', newReceipt);
            document.getElementById('financial-filter').addEventListener('change', updateFinancial);
            document.getElementById('save-transaction').addEventListener('click', saveTransaction);
            document.getElementById('print-receipt').addEventListener('click', printReceipt);
            document.getElementById('download-receipt').addEventListener('click', downloadReceipt);

            // Botões de relatórios
            document.querySelectorAll('.pdf-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    generatePDFReport(this.getAttribute('data-report-type'));
                });
            });
            // Botões de backup
            document.getElementById('export-backup').addEventListener('click', exportBackup);
            document.getElementById('import-backup').addEventListener('click', function() {
                document.getElementById('backup-file').click();
            });
            document.getElementById('backup-file').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    importBackup(e.target.files[0]);
                }
            });
            // Configuração de frequência de backup
            document.getElementById('backup-frequency').addEventListener('change', function() {
                settings.backupFrequency = this.value;
                saveData();
                configureBackupFrequency();
            });
            // Botões de configurações
            document.getElementById('save-branding').addEventListener('click', saveBranding);
            document.getElementById('new-user-btn').addEventListener('click', newUser);
            document.getElementById('save-user').addEventListener('click', saveUser);

            // Botão de login
            document.getElementById('login-btn').addEventListener('click', login);
            // Eventos dos modais
            document.querySelectorAll('.close, .close-modal, .close-alert').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            // Fecha modais ao clicar fora
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            setupPrintButtons(); // Setup print buttons after DOM is loaded and buttons exist

            // Event listeners para a página de Tabelas
            const importButton = document.getElementById('import-table-btn');
            if (importButton) {
                 importButton.addEventListener('click', importTableFile);
            }

            const tablesMenuItem = document.querySelector('.menu-item[data-page="tables"]');
            if (tablesMenuItem) {
                tablesMenuItem.addEventListener('click', function() {
                    loadPropertiesForImport();
                    updateImportHistory();
                });
            }

            // Event listeners para a página de Notas
            const saveNotesButton = document.getElementById('save-notes');
            if (saveNotesButton) { // Check if the button exists
                saveNotesButton.addEventListener('click', saveNotes);
            }

            const printNotesButton = document.getElementById('print-notes');
             if (printNotesButton) { // Check if the button exists
                printNotesButton.addEventListener('click', printNotes);
             }

            // Event listeners para o Visualizador de Imagens
            document.getElementById('prev-image-btn').addEventListener('click', () => {
                navigateImageViewer(-1);
            });
            document.getElementById('next-image-btn').addEventListener('click', () => {
                navigateImageViewer(1);
            });
            // Close image viewer when clicking outside image or on close button
            document.getElementById('image-viewer-modal').addEventListener('click', function(e) {
                if (e.target === this || e.target.classList.contains('close')) {
                     hideModal('image-viewer-modal');
                }
            });


        }

        // Funções globais para uso no HTML
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.viewLead = viewLead; // Make viewLead global
        window.editProperty = editProperty;
        window.deleteProperty = deleteProperty;
        window.viewProperty = viewProperty; // Make viewProperty global
        window.removePropertyImage = removePropertyImage;
        window.removeLeadDocument = removeLeadDocument; // Make removeLeadDocument global
        window.editAppointment = editAppointment;
        window.deleteAppointment = deleteAppointment;
        window.viewAppointment = viewAppointment; // Make viewAppointment global
        window.markAppointmentAsCompleted = markAppointmentAsCompleted; // Make markAppointmentAsCompleted global
        window.editTransaction = editTransaction;
        window.deleteTransaction = deleteTransaction;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.checkPassword = checkPassword;
        window.moveLeadToNextStage = moveLeadToNextStage;
        window.hideAppointmentAlert = hideAppointmentAlert;
        window.viewImportDetails = viewImportDetails; // Make viewImportDetails global
        window.downloadPropertyPdf = downloadPropertyPdf; // Make downloadPropertyPdf global


    </script>
    <script>
        function updateFunnel() {
            const statuses = {
                "Novo": "new-leads-list",
                "Contatado": "contacted-leads-list",
                "Interessado": "interested-leads-list",
                "Proposta Enviada": "proposal-leads-list",
                "Negociação": "negotiation-leads-list",
                "Fechado": "closed-leads-list"
            };
            for (let status in statuses) {
                const container = document.getElementById(statuses[status]);
                if (!container) continue;
                const filtered = leads.filter(lead => lead.status === status);
                container.innerHTML = '';
                const countEl = document.getElementById(statuses[status].replace('-list', '-count'));
                if (countEl) countEl.textContent = filtered.length;

                filtered.forEach(lead => {
                    const div = document.createElement('div');
                    div.className = 'funnel-lead';
                    // Add data-id for easier lookup
                    div.setAttribute('data-id', lead.id);

                    div.innerHTML = `
                        <span class="funnel-lead-name">${lead.name}</span>
                        <div class="funnel-lead-actions">
                            ${lead.status !== 'Fechado' ? `
                            <button class="btn btn-success btn-sm" onclick="moveLeadToNextStage(${lead.id})">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="viewLead(${lead.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editLead(${lead.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function enableDragAndDrop() {
            const statuses = [
                "new-leads-list", "contacted-leads-list", "interested-leads-list",
                "proposal-leads-list", "negotiation-leads-list", "closed-leads-list"
            ];
            statuses.forEach(id => {
                const container = document.getElementById(id);
                if (container && !container.classList.contains('sortable-initialized')) { // Prevent re-initialization
                    new Sortable(container, {
                        group: "leads",
                        animation: 150,
                         // Use the data-id attribute to find the lead
                        onEnd: function (evt) {
                         const leadElement = evt.item;
                             const leadId = parseInt(leadElement.getAttribute('data-id'));
                             let lead = leads.find(l => l.id === leadId);

                             const newStatus = {
                                "new-leads-list": "Novo",
                                "contacted-leads-list": "Contatado",
                                "interested-leads-list": "Interessado",
                                "proposal-leads-list": "Proposta Enviada",
                                "negotiation-leads-list": "Negociação",
                                "closed-leads-list": "Fechado"
                            }[evt.to.id];
                            if (lead) {
                                lead.status = newStatus;
                                saveData();
                                updateUI();
                            }
                        }
                    });
                    container.classList.add('sortable-initialized'); // Mark as initialized
                }
            });
        }

        function showLeadAlerts() {
            const interested = leads.filter(l => l.status === 'Interessado').length;
            const proposal = leads.filter(l => l.status === 'Proposta Enviada').length;

            let alertText = '';
            if (interested > 0) alertText += `💬 ${interested} leads interessados!\n`;
            if (proposal > 0) alertText += `📄 ${proposal} aguardando proposta.`;
            if (alertText !== '') ; // Removed alert, will use the new appointment alert mechanism if needed in the future
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateFunnel();
            enableDragAndDrop();
            setTimeout(showLeadAlerts, 2000);
            // Check backup frequency settings before setting interval
            if (settings.backupFrequency !== 'manual' && settings.backupFrequency !== 'onclose') {
                 setInterval(function() {
                    exportBackupToFile();
                    console.log("Backup automático executado.");
                }, 300000); // Backup every 5 minutes
             }
        });
    </script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const backupFrequency = localStorage.getItem('backupFrequency') || 'manual';

    if (backupFrequency !== 'manual') {
        autoImportBackup();
    }

    const freqSelect = document.getElementById('backup-frequency');
    if (freqSelect) {
        freqSelect.value = backupFrequency;
        freqSelect.addEventListener('change', (e) => {
            localStorage.setItem('backupFrequency', e.target.value);
        });
    }
});

function autoImportBackup() {
    const backupData = localStorage.getItem('crmBackup');
    if (!backupData) {
        updateBackupStatus('Nenhum backup encontrado para importar.', false);
        return;
    }

    try {
        const data = JSON.parse(backupData);
        restoreData(data);
        updateBackupStatus('Backup importado automaticamente com sucesso.', true);
    } catch (e) {
        updateBackupStatus('Erro ao importar backup automático.', false);
    }
}

function restoreData(data) {
    if (data.leads) localStorage.setItem('leads', JSON.stringify(data.leads));
    if (data.properties) localStorage.setItem('properties', JSON.stringify(data.properties));
    if (data.appointments) localStorage.setItem('appointments', JSON.stringify(data.appointments));
    if (data.transactions) localStorage.setItem('transactions', JSON.stringify(data.transactions));
}

function updateBackupStatus(message, success = true) {
    const statusEl = document.getElementById('backup-status');
    const timeEl = document.getElementById('last-backup-time');

    if (statusEl) {
        statusEl.className = 'backup-status ' + (success ? 'success' : 'error');
        statusEl.innerText = message;
    }

    if (success && timeEl) {
        timeEl.innerText = new Date().toLocaleString();
    }
}
</script>

<script>
    // Exibição da aba "Links"
    document.querySelector('[data-page="links"]').addEventListener('click', function () {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.getElementById('links-page').style.display = 'block';
        this.classList.add('active');
        loadLinks();
    });

    // Adicionar novo link
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-link-btn').addEventListener('click', function () {
            const name = prompt("Nome do link:");
            if (!name) return;
            const url = prompt("URL do link:");
            if (!url) return;
            const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
            links.push({ name, url });
            localStorage.setItem("importantLinks", JSON.stringify(links));
            loadLinks();
        });
    });

    function loadLinks() {
        const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
        const table = document.getElementById("links-table");
        table.innerHTML = "";
        links.forEach((link, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${link.name}</td>
                <td><a href="${link.url}" target="_blank">${link.url}</a></td>
                <td><button class="btn btn-danger btn-sm" onclick="removeLink(${index})">Remover</button></td>
            `;
            table.appendChild(row);
        });
    }

    function removeLink(index) {
        const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
        links.splice(index, 1);
        localStorage.setItem("importantLinks", JSON.stringify(links));
        loadLinks();
    }
</script>
<script>
    // Exibição da aba "Links"
    document.querySelector('[data-page="links"]').addEventListener('click', function () {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.getElementById('links-page').style.display = 'block';
        this.classList.add('active');
        loadLinks();
    });

    // Abrir modal ao clicar no botão "Adicionar Link"
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-link-btn').addEventListener('click', function () {
            document.getElementById('link-name').value = '';
            document.getElementById('link-url').value = '';
            document.getElementById('link-modal').style.display = 'flex';
        });

        document.getElementById('save-link-btn').addEventListener('click', function () {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            if (!name || !url) return alert('Preencha todos os campos!');
            const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
            links.push({ name, url });
            localStorage.setItem("importantLinks", JSON.stringify(links));
            document.getElementById('link-modal').style.display = 'none';
            loadLinks();
        });
    });

    function loadLinks() {
        const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
        const table = document.getElementById("links-table");
        table.innerHTML = "";
        links.forEach((link, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${link.name}</td>
                <td><a href="${link.url}" target="_blank">${link.url}</a></td>
                <td><button class="btn btn-danger btn-sm" onclick="removeLink(${index})">Remover</button></td>
            `;
            table.appendChild(row);
        });
    }

    function removeLink(index) {
        const links = JSON.parse(localStorage.getItem("importantLinks") || "[]");
        links.splice(index, 1);
        localStorage.setItem("importantLinks", JSON.stringify(links));
        loadLinks();
    }
</script>
